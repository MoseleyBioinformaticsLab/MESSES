<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>messes.extract.extract &mdash; MESSES 0.1.dev1+g089fe0d documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/custom_css.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js"></script>
        <script src="../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MESSES
          </a>
              <div class="version">
                0.1.dev1+g089fe0d
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tagging.html">Tagging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conversion_directives.html">Conversion Directives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiment_description_schema.html">Experiment Description Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../protocol_dependent_schema.html">Protocol-Dependent Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../supported_formats.html">Supported Conversion Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../todo.html">TODO List</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MESSES</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>messes.extract.extract</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for messes.extract.extract</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python3</span>
<span class="sd">&quot;&quot;&quot; </span>
<span class="sd">Extract data from Excel workbooks, csv files, and JSON files.</span>
<span class="sd">    </span>
<span class="sd"> Usage:</span>
<span class="sd">    messes extract &lt;metadata_source&gt;... [--delete &lt;metadata_section&gt;...] [options]</span>
<span class="sd">    messes extract --help</span>

<span class="sd">    &lt;metadata_source&gt; - tagged input metadata source as csv/json filename or </span>
<span class="sd">                        xlsx_filename[:worksheet_name|regular_expression] or </span>
<span class="sd">                        google_sheets_url[:worksheet_name|regular_expression]</span>
<span class="sd">                        &quot;#export&quot; worksheet name is the default.</span>

<span class="sd"> Options:</span>
<span class="sd">    -h, --help                          - show this help documentation.</span>
<span class="sd">    -v, --version                       - show the version.</span>
<span class="sd">    --silent                            - print no warning messages.</span>
<span class="sd">    --output &lt;filename_json&gt;            - output json filename.</span>
<span class="sd">    --compare &lt;filename_json&gt;           - compare extracted metadata to given JSONized metadata.</span>
<span class="sd">    --modify &lt;source&gt;                   - modification directives worksheet name, regular expression, csv/json filename, or </span>
<span class="sd">                                          xlsx_filename:[worksheet_name|regular_expression] or </span>
<span class="sd">                                          google_sheets_url[:worksheet_name|regular_expression] </span>
<span class="sd">                                          [default: #modify].</span>
<span class="sd">    --end-modify &lt;source&gt;               - apply modification directives after all metadata merging. Requires csv/json filename or </span>
<span class="sd">                                          xlsx_filename:[worksheet_name|regular_expression] or </span>
<span class="sd">                                          google_sheets_url[:worksheet_name|regular_expression].</span>
<span class="sd">    --automate &lt;source&gt;                 - automation directives worksheet name, regular expression, csv/json filename, or </span>
<span class="sd">                                          xlsx_filename:[worksheet_name|regular_expression] or </span>
<span class="sd">                                          google_sheets_url[:worksheet_name|regular_expression] </span>
<span class="sd">                                          [default: #automate].</span>
<span class="sd">    --save-directives &lt;filename_json&gt;   - output filename with modification and automation directives in JSON format.</span>
<span class="sd">    --save-export &lt;filetype&gt;            - output export worksheet with suffix &quot;_export&quot; and with the indicated xlsx/csv format extension.</span>
<span class="sd">    --show &lt;show_option&gt;                - show a part of the metadata. See options below.</span>
<span class="sd">    --delete &lt;metadata_section&gt;...      - delete a section of the JSONized metadata. Section format is tableKey or tableKey,IDKey or tableKey,IDKey,fieldName. These can be regular expressions.</span>
<span class="sd">    --keep &lt;metadata_tables&gt;            - only keep the selected tables.  Delete the rest.  Table format is tableKey,tableKey,... The tableKey can be a regular expression.</span>
<span class="sd">    --file-cleaning &lt;remove_regex&gt;      - a string or regular expression to remove characters in input files, removes unicode and \r characters by default, enter &quot;None&quot; to disable [default: _x([0-9a-fA-F]{4})_|\r].</span>

<span class="sd">Show Options:</span>
<span class="sd">  tables    - show tables in the extracted metadata.</span>
<span class="sd">  lineage   - show parent-child lineages per table.</span>
<span class="sd">  all       - show every option.</span>

<span class="sd">Regular Expression Format:</span>
<span class="sd">  Regular expressions have the form &quot;r&#39;...&#39;&quot; on the command line.</span>
<span class="sd">  The re.match function is used, which matches from the beginning of a string, meaning that a regular expression matches as if it starts with a &quot;^&quot;.</span>

<span class="sd"> Directives JSON Format:</span>
<span class="sd">   {</span>
<span class="sd">    &quot;modification&quot; : { table : { field :  { &quot;(exact|regex|levenshtein)\-(first|first\-nowarn|unique|all)&quot; :</span>
<span class="sd">                      { field_value : { &quot;assign&quot; : { field : value,... }, &quot;append&quot; : { field : value,... }, &quot;prepend&quot; : { field : value,... },</span>
<span class="sd">                                        &quot;regex&quot; : { field : regex_pair,... }, &quot;delete&quot; : [ field,... ], &quot;rename&quot; : { old_field : new_field } } } } } }</span>
<span class="sd">    &quot;automation&quot; : [ { &quot;header_tag_descriptions&quot; : [ { &quot;header&quot; : column_description, &quot;tag&quot; : tag_description, &quot;required&quot; : true|false } ],   &quot;exclusion_test&quot; : exclusion_value, &quot;insert&quot; : [ [ cell_content, ... ] ] } ]</span>
<span class="sd">   }</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#   Written by Hunter Moseley, 06/18/2014</span>
<span class="c1">#   Copyright Hunter Moseley, 06/18/2014. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1">#   Hugely Revised (Over 75%) by Hunter Moseley, 08/29/2020</span>
<span class="c1">#   Copyright Hunter Moseley, 08/29/2020. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1">#   Revised significantly by Travis Thompson, 03/03/2023</span>



<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TextIO</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib.error</span>

<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">docopt</span>
<span class="kn">import</span> <span class="nn">jellyfish</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">messes.extract</span> <span class="kn">import</span> <span class="n">cythonized_tagSheet</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">messes.extract</span> <span class="kn">import</span> <span class="n">tagSheet</span> <span class="k">as</span> <span class="n">cythonized_tagSheet</span>
<span class="kn">from</span> <span class="nn">messes</span> <span class="kn">import</span> <span class="n">__version__</span>

<span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">docopt</span><span class="o">.</span><span class="n">docopt</span><span class="p">(</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">__version__</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--silent&quot;</span><span class="p">]:</span>
        <span class="k">global</span> <span class="n">silent</span>
        <span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--file-cleaning&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--file-cleaning&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
    
    <span class="n">tagParser</span> <span class="o">=</span> <span class="n">TagParser</span><span class="p">()</span>
        

    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="kc">True</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;--modify&quot;</span><span class="p">]):</span>
        <span class="n">modifyDefaulted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">modifyDefaulted</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="kc">True</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;--automate&quot;</span><span class="p">]):</span>
        <span class="n">automateDefaulted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">automateDefaulted</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">for</span> <span class="n">metadataSource</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;&lt;metadata_source&gt;&quot;</span><span class="p">]:</span>
        <span class="n">tagParser</span><span class="o">.</span><span class="n">readMetadata</span><span class="p">(</span><span class="n">metadataSource</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--automate&quot;</span><span class="p">],</span> <span class="n">automateDefaulted</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--modify&quot;</span><span class="p">],</span> <span class="n">modifyDefaulted</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--file-cleaning&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--save-export&quot;</span><span class="p">])</span>

    <span class="c1">## --end-modify is needed so that the merged metadata files can all be modified after being merged together.</span>
    <span class="c1">## Without this each metadatasource only gets its own modification.</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--end-modify&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">modificationSource</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--end-modify&quot;</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">hasFileExtension</span><span class="p">(</span><span class="n">modificationSource</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">isGoogleSheetsFile</span><span class="p">(</span><span class="n">modificationSource</span><span class="p">):</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.*\.xls[xm]?)&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">)):</span>
                   <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
                   <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="n">modificationSource</span>
               <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/.*$&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">)):</span>
                   <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
                   <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="n">modificationSource</span>
               <span class="k">else</span><span class="p">:</span>
                   <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">modificationSource</span>
                   <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.xls[xm]?$&quot;</span><span class="p">,</span> <span class="n">modificationSource</span><span class="p">):</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">modificationSource</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="s2">&quot;#modify&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.*\.xls[xm]?):(.*)$&quot;</span><span class="p">,</span> <span class="n">modificationSource</span><span class="p">)):</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/[^:]*$&quot;</span><span class="p">,</span> <span class="n">modificationSource</span><span class="p">)):</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="s2">&quot;#modify&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/.*:(.*)$&quot;</span><span class="p">,</span> <span class="n">modificationSource</span><span class="p">)):</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">modificationSource</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">modificationDirectives</span> <span class="o">=</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">readDirectives</span><span class="p">(</span><span class="n">modificationFilePath</span><span class="p">,</span> <span class="n">modificationSheetName</span><span class="p">,</span> <span class="s2">&quot;modification&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--file-cleaning&quot;</span><span class="p">])</span>
        <span class="n">tagParser</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span><span class="n">modificationDirectives</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tagParser</span><span class="p">,</span> <span class="s2">&quot;unusedModifications&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">modificationID</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">unusedModifications</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: modification directive #&quot;</span> <span class="o">+</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fieldKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">comparisonType</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">modificationID</span> <span class="o">+</span> <span class="s2">&quot; never matched.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--delete&quot;</span><span class="p">]:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[</span> <span class="n">section</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--delete&quot;</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">tagParser</span><span class="o">.</span><span class="n">deleteMetadata</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--keep&quot;</span><span class="p">]:</span>
        <span class="n">keep_strings</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--keep&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">keep_regexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">keep_strings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
                <span class="n">keep_regexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">string</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keep_regexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">))</span>
        
        <span class="n">tables_to_keep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">regex</span> <span class="ow">in</span> <span class="n">keep_regexes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">extraction</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
                    <span class="n">tables_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">tableKey</span> <span class="p">]</span> <span class="k">for</span> <span class="n">tableKey</span> <span class="ow">in</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">extraction</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">tableKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables_to_keep</span> <span class="p">]</span>
        <span class="n">tagParser</span><span class="o">.</span><span class="n">deleteMetadata</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--show&quot;</span><span class="p">]:</span>
        
        <span class="n">validShowSubOption</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--show&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tables&quot;</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--show&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tables: &quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tagParser</span><span class="o">.</span><span class="n">extraction</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">validShowSubOption</span> <span class="o">=</span> <span class="kc">True</span>
    
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--show&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;lineage&quot;</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--show&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">lineages</span> <span class="o">=</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">generateLineages</span><span class="p">()</span>
            <span class="n">tagParser</span><span class="o">.</span><span class="n">printLineages</span><span class="p">(</span><span class="n">lineages</span><span class="p">,</span><span class="n">indentation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">validShowSubOption</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validShowSubOption</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown sub option for </span><span class="se">\&quot;</span><span class="s2">--show</span><span class="se">\&quot;</span><span class="s2"> option: </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--show&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--output&quot;</span><span class="p">]:</span> <span class="c1"># save to JSON</span>
        <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;--output&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--output&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;--output&quot;</span><span class="p">],</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span> <span class="p">:</span>
            <span class="n">jsonFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tagParser</span><span class="o">.</span><span class="n">extraction</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--compare&quot;</span><span class="p">]:</span>
        <span class="n">comparePath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;--compare&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">comparePath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">comparePath</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: The provided file for comparison is not a JSON file.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">comparePath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span><span class="p">:</span>
                    <span class="n">otherMetadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonFile</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparison&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">otherMetadata</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No differences detected.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: The provided file for comparison does not exist.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--save-directives&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;--save-directives&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--save-directives&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--save-directives&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tagParser</span><span class="p">,</span> <span class="s2">&quot;modificationDirectives&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tagParser</span><span class="p">,</span> <span class="s2">&quot;automationDirectives&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">directives</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tagParser</span><span class="p">,</span> <span class="s2">&quot;modificationDirectives&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">directives</span><span class="p">[</span><span class="s2">&quot;modification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">modificationDirectives</span>

            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tagParser</span><span class="p">,</span> <span class="s2">&quot;automationDirectives&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">directives</span><span class="p">[</span><span class="s2">&quot;automation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">automationDirectives</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;--save-directives&quot;</span><span class="p">],</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span> <span class="p">:</span>
                <span class="n">jsonFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">directives</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no directives to save.&quot;</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>


<div class="viewcode-block" id="xstr"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.xstr">[docs]</a><span class="k">def</span> <span class="nf">xstr</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns str(s) or &quot;&quot; if s is None.</span>

<span class="sd">    Args:</span>
<span class="sd">        s: input string or None.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str(s) or &quot;&quot; if s is None.        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

    

<div class="viewcode-block" id="Evaluator"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.Evaluator">[docs]</a><span class="k">class</span> <span class="nc">Evaluator</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates object that calls eval with a given record.&quot;&quot;&quot;</span>

    <span class="n">evalDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*eval\((.*)\)\s*$&#39;</span><span class="p">)</span>
    <span class="n">fieldDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\#(.*)\#$&#39;</span><span class="p">)</span>
    <span class="n">reDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;r[</span><span class="se">\&quot;</span><span class="s2">&#39;](.*)[</span><span class="se">\&quot;</span><span class="s2">&#39;]$&quot;</span><span class="p">)</span>
    <span class="n">evalSplitter</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\#[^#]+\#)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evalString</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">useFieldTests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">listAsString</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializer</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            evalString: string of the form eval(...) to deliver to eval(), &quot;eval(&quot; and &quot;)&quot; will be removed.</span>
<span class="sd">            useFieldTests: whether to use field tests in field name modification.</span>
<span class="sd">            listAsString: whether to convert a list into a single string.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evalString</span> <span class="o">=</span> <span class="n">evalString</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useFieldTests</span> <span class="o">=</span> <span class="n">useFieldTests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listAsString</span> <span class="o">=</span> <span class="n">listAsString</span>

        <span class="n">tokenList</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Evaluator</span><span class="o">.</span><span class="n">evalSplitter</span><span class="p">,</span> <span class="n">evalString</span><span class="p">)</span> <span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">token</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldTests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requiredFields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">finalTokenList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">regexCount</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokenList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">Evaluator</span><span class="o">.</span><span class="n">fieldDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
                <span class="n">fieldString</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">Evaluator</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">fieldString</span><span class="p">):</span>
                    <span class="n">fieldString</span> <span class="o">=</span> <span class="s2">&quot;REGEX&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">regexCount</span><span class="p">)</span>
                    <span class="n">regexCount</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">finalTokenList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldString</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fieldTests</span><span class="p">[</span><span class="n">fieldString</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">finalTokenList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;_PERCENT_&quot;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">requiredFields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldString</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">finalTokenList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">useFieldTests</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requiredFields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldTests</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">finalTokenList</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalString</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Evaluator.evaluate"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.Evaluator.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="o">|</span><span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return eval results for the given record.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            record: record from TagParser.extraction.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            The results from eval() with the record&#39;s contents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">restricted</span> <span class="o">=</span> <span class="p">{</span> <span class="n">field</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="s2">&quot;_PERCENT_&quot;</span><span class="p">)</span> <span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requiredFields</span> <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useFieldTests</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldTests</span><span class="p">:</span>
            <span class="n">restricted</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>  <span class="p">[(</span><span class="n">fieldName</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">fieldTest</span><span class="p">,</span><span class="n">field</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fieldName</span><span class="p">,</span> <span class="n">fieldTest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldTests</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">})</span>

        <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span><span class="n">restricted</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">listAsString</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xstr</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span><span class="n">restricted</span><span class="p">))</span></div>

<div class="viewcode-block" id="Evaluator.hasRequiredFields"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.Evaluator.hasRequiredFields">[docs]</a>    <span class="k">def</span> <span class="nf">hasRequiredFields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether the record has all required fields.</span>

<span class="sd">        Args:</span>
<span class="sd">            record: record from TagParser.extraction.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if the record has all required fiels, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="n">record</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requiredFields</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">useFieldTests</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldTests</span> <span class="ow">or</span> \
               <span class="nb">all</span><span class="p">([</span> <span class="nb">len</span><span class="p">([(</span><span class="n">fieldName</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">fieldTest</span><span class="p">,</span><span class="n">field</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">fieldName</span><span class="p">,</span> <span class="n">fieldTest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldTests</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">])</span> <span class="p">)</span></div>

<div class="viewcode-block" id="Evaluator.isEvalString"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.Evaluator.isEvalString">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">isEvalString</span><span class="p">(</span><span class="n">evalString</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">re</span><span class="o">.</span><span class="n">Match</span><span class="o">|</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests whether the evalString is of the form r&quot;^eval(...)$&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            evalString: a string to determine whether or not it is of the eval variety.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            An re.Match object if the evalString is indeed an eval string, or None if it is not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">Evaluator</span><span class="o">.</span><span class="n">evalDetector</span><span class="p">,</span> <span class="n">evalString</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="Operand"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.Operand">[docs]</a><span class="k">class</span> <span class="nc">Operand</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class of objects that create string operands for concatenation operations.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializer</span>

<span class="sd">        Args:</span>
<span class="sd">            value: a string or int that represents the value of the operand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Passes, exists to be overridden.</span>

<span class="sd">        Args:</span>
<span class="sd">            record: record from TagParser.extraction.</span>
<span class="sd">            row: pandas Series that is a row from metadata being parsed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="LiteralOperand"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.LiteralOperand">[docs]</a><span class="k">class</span> <span class="nc">LiteralOperand</span><span class="p">(</span><span class="n">Operand</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents string literal operands.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns string value.</span>

<span class="sd">        Args:</span>
<span class="sd">            record: record from TagParser.extraction.</span>
<span class="sd">            row: pandas Series that is a row from metadata being parsed.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            String value of the operand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="VariableOperand"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.VariableOperand">[docs]</a><span class="k">class</span> <span class="nc">VariableOperand</span><span class="p">(</span><span class="n">Operand</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents #table.record%attribute variable operands.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns record field value.</span>

<span class="sd">        Args:</span>
<span class="sd">            record: record from TagParser.extraction.</span>
<span class="sd">            row: pandas Series that is a row from metadata being parsed.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            The value of the record&#39;s field where field is the operand&#39;s value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">]</span></div>

<div class="viewcode-block" id="ColumnOperand"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.ColumnOperand">[docs]</a><span class="k">class</span> <span class="nc">ColumnOperand</span><span class="p">(</span><span class="n">Operand</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents specific worksheet cells in a given column as operands.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rerurns column value in the given row.</span>

<span class="sd">        Args:</span>
<span class="sd">            record: record from TagParser.extraction.</span>
<span class="sd">            row: pandas Series that is a row from metadata being parsed.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            xstr(row.iloc[self.value]).strip() of a column in the row. The column returned is the index based on the operand&#39;s value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">xstr</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>

<div class="viewcode-block" id="FieldMaker"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.FieldMaker">[docs]</a><span class="k">class</span> <span class="nc">FieldMaker</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates objects that convert specific information from a worksheet row into a field via concatenation of a list of operands.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializer</span>

<span class="sd">        Args:</span>
<span class="sd">            field: name of a field in a record from TagParser.extraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operands</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="FieldMaker.create"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.FieldMaker.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates field-value and adds to record using row and record.</span>

<span class="sd">        Args:</span>
<span class="sd">            record: record from TagParser.extraction.</span>
<span class="sd">            row: pandas Series that is a row from metadata being parsed.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Value created by applying all operands in self.operands and written into record[self.field].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span> <span class="p">:</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="n">operand</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

        <span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="FieldMaker.shallowClone"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.FieldMaker.shallowClone">[docs]</a>    <span class="k">def</span> <span class="nf">shallowClone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldMaker</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns clone with shallow copy of operands.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of self, but with a shallow copy of operands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="n">FieldMaker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">)</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">operands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span>
        <span class="k">return</span> <span class="n">clone</span></div></div>


<div class="viewcode-block" id="ListFieldMaker"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.ListFieldMaker">[docs]</a><span class="k">class</span> <span class="nc">ListFieldMaker</span><span class="p">(</span><span class="n">FieldMaker</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates objects that convert specific information from a worksheet row into a list field via appending of a list of operands.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ListFieldMaker.create"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.ListFieldMaker.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates field-value and adds to record using PARAMETERS row and record.</span>

<span class="sd">        Args:</span>
<span class="sd">            record: record from TagParser.extraction.</span>
<span class="sd">            row: pandas Series that is a row from metadata being parsed.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Value created by applying all operands in self.operands and written into record[self.field].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">ColumnOperand</span><span class="p">)</span> <span class="p">:</span> <span class="c1"># split column operands into separate values.</span>
                <span class="c1">## If the list field contains semicolons use it to split instead of commas.</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*;.*&quot;</span><span class="p">,</span> <span class="n">operand</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">row</span><span class="p">)):</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">operand</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">operand</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operand</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="ow">in</span> <span class="n">record</span> <span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">value</span></div>

    <span class="c1">## Currently I don&#39;t think this can be called from the CLI. </span>
    <span class="c1">## The only time shallowClone is called is when a child is created and that is </span>
    <span class="c1">## only ever called on a FieldMaker type, not ListFieldMaker.</span>
<div class="viewcode-block" id="ListFieldMaker.shallowClone"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.ListFieldMaker.shallowClone">[docs]</a>    <span class="k">def</span> <span class="nf">shallowClone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ListFieldMaker</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns clone with shallow copy of operands.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of self, but with a shallow copy of operands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="n">ListFieldMaker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">)</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">operands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span>
        <span class="k">return</span> <span class="n">clone</span></div></div>


<div class="viewcode-block" id="RecordMaker"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker">[docs]</a><span class="k">class</span> <span class="nc">RecordMaker</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates objects that convert worksheet rows into records for specific tables.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializer&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="RecordMaker.child"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.child">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">child</span><span class="p">(</span><span class="n">example</span><span class="p">:</span> <span class="n">RecordMaker</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parentIDIndex</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RecordMaker</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns child object derived from a example object.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            example: RecordMaker with global literal fields.</span>
<span class="sd">            table: table where the child record will go.</span>
<span class="sd">            parentIDIndex: column index for parentID of the child record.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            RecordMaker to make a new child record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">RecordMaker</span><span class="p">()</span>
        <span class="n">child</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="n">child</span><span class="o">.</span><span class="n">fieldMakers</span> <span class="o">=</span> <span class="p">[</span> <span class="n">maker</span><span class="o">.</span><span class="n">shallowClone</span><span class="p">()</span> <span class="k">for</span> <span class="n">maker</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">fieldMakers</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">maker</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">fieldMakers</span> <span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;(\w*)\.(.*)$&#39;</span><span class="p">,</span> <span class="n">maker</span><span class="o">.</span><span class="n">field</span><span class="p">))</span> <span class="ow">and</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">table</span> <span class="p">:</span>
                <span class="n">maker</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">child</span><span class="o">.</span><span class="n">addField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="s2">&quot;parent_id&quot;</span><span class="p">)</span>
        <span class="n">child</span><span class="o">.</span><span class="n">addColumnOperand</span><span class="p">(</span><span class="n">parentIDIndex</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">child</span></div>

<div class="viewcode-block" id="RecordMaker.create"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns record created from given row.</span>

<span class="sd">        Args:</span>
<span class="sd">            row: pandas Series that is a row from metadata being parsed.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            The table string and created record in a tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fieldMaker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span> <span class="p">:</span>
            <span class="n">fieldMaker</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">record</span></div>

<div class="viewcode-block" id="RecordMaker.addField"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.addField">[docs]</a>    <span class="k">def</span> <span class="nf">addField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fieldMakerClass</span><span class="p">:</span> <span class="n">FieldMaker</span><span class="o">|</span><span class="n">ListFieldMaker</span> <span class="o">=</span> <span class="n">FieldMaker</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates and adds new FieldMaker object.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: table name to add.</span>
<span class="sd">            field: field name to add.</span>
<span class="sd">            fieldMakerClass: which type of FieldMaker to add to self.fieldMakers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldMakerClass</span><span class="p">(</span><span class="n">field</span><span class="p">))</span></div>

<div class="viewcode-block" id="RecordMaker.addGlobalField"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.addGlobalField">[docs]</a>    <span class="k">def</span> <span class="nf">addGlobalField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">literal</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fieldMakerClass</span><span class="p">:</span> <span class="n">FieldMaker</span><span class="o">|</span><span class="n">ListFieldMaker</span> <span class="o">=</span> <span class="n">FieldMaker</span><span class="p">)</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates and adds new FieldMaker with literal operand that will be used as global fields for all records created from a row.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: table name to add.</span>
<span class="sd">            field: field name to add.</span>
<span class="sd">            literal: value of the field to be added.</span>
<span class="sd">            fieldMakerClass: which type of FieldMaker to add to self.fieldMakers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldMakerClass</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">operands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LiteralOperand</span><span class="p">(</span><span class="n">literal</span><span class="p">))</span></div>

<div class="viewcode-block" id="RecordMaker.addVariableOperand"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.addVariableOperand">[docs]</a>    <span class="k">def</span> <span class="nf">addVariableOperand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add field as a variable operand to the last FieldMaker.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: table name to add.</span>
<span class="sd">            field: field name to add.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">operands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VariableOperand</span><span class="p">(</span><span class="n">field</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="RecordMaker.addLiteralOperand"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.addLiteralOperand">[docs]</a>    <span class="k">def</span> <span class="nf">addLiteralOperand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">literal</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add literal as an operand to the last FieldMaker.</span>

<span class="sd">        Args:</span>
<span class="sd">            literal: value to append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">operands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LiteralOperand</span><span class="p">(</span><span class="n">literal</span><span class="p">))</span></div>

<div class="viewcode-block" id="RecordMaker.addColumnOperand"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.addColumnOperand">[docs]</a>    <span class="k">def</span> <span class="nf">addColumnOperand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columnIndex</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add columnIndex as a column variable operand to the last FieldMaker.</span>

<span class="sd">        Args:</span>
<span class="sd">            columnIndex: column number to add.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">operands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColumnOperand</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">))</span></div>

<div class="viewcode-block" id="RecordMaker.isInvalidDuplicateField"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.isInvalidDuplicateField">[docs]</a>    <span class="k">def</span> <span class="nf">isInvalidDuplicateField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fieldMakerClass</span><span class="p">:</span> <span class="n">FieldMaker</span><span class="o">|</span><span class="n">ListFieldMaker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether a given table.field is an invalid duplicate in the current RecordMaker.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: table name to look for.</span>
<span class="sd">            field: field name to look for.</span>
<span class="sd">            fieldMakerClass: uses this type to do the correct checks.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if table.field is an invalid duplicate, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">fieldMakerClass</span> <span class="o">==</span> <span class="n">FieldMaker</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasShortField</span><span class="p">(</span><span class="n">field</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">([</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="n">field</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">ListFieldMaker</span><span class="p">)</span> <span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="RecordMaker.hasField"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.hasField">[docs]</a>    <span class="k">def</span> <span class="nf">hasField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether a given table.field exists in the current RecordMaker.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: table name to look for.</span>
<span class="sd">            field: field name to look for.</span>
<span class="sd">            offset: offset from end to stop looking for #table.field.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if table.field exists, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasShortField</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> </div>

<div class="viewcode-block" id="RecordMaker.hasShortField"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.hasShortField">[docs]</a>    <span class="k">def</span> <span class="nf">hasShortField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether a given field exists in the current RecordMaker.</span>

<span class="sd">        Args:</span>
<span class="sd">            field: field name to look for.</span>
<span class="sd">            offset: offset from end to stop looking for #table.field.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if field exists, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="n">field</span> <span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> </div>

<div class="viewcode-block" id="RecordMaker.isLastField"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.isLastField">[docs]</a>    <span class="k">def</span> <span class="nf">isLastField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether the last FieldMaker is for table.field.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: table name to look for.</span>
<span class="sd">            field: field name to look for.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if the last FieldMaker is for table.field, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="n">field</span></div>

<div class="viewcode-block" id="RecordMaker.hasValidID"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.hasValidID">[docs]</a>    <span class="k">def</span> <span class="nf">hasValidID</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether there is a valid id field.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if there is a valid id field, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasShortField</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortField</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">ColumnOperand</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortField</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="n">ListFieldMaker</span></div>

<div class="viewcode-block" id="RecordMaker.properField"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.properField">[docs]</a>    <span class="k">def</span> <span class="nf">properField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns proper field name based on given table and field and internal self.table.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: table name to check against internal table name and build proper field name with.</span>
<span class="sd">            field: field name to build proper field name with.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            &quot;table.field&quot; with the appropriate table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">table</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">field</span>
        <span class="k">return</span> <span class="n">field</span></div>

    <span class="c1">## This is currently never called anywhere, so cannot be tested through the CLI.</span>
<div class="viewcode-block" id="RecordMaker.field"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.field">[docs]</a>    <span class="k">def</span> <span class="nf">field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldMaker</span><span class="o">|</span><span class="n">ListFieldMaker</span><span class="o">|</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns FieldMaker for table.field.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: table name to look for FieldMaker.</span>
<span class="sd">            field: field name to look for FieldMaker.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            The FieldMaker for the table.field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortField</span><span class="p">(</span><span class="n">field</span><span class="p">)</span></div>

<div class="viewcode-block" id="RecordMaker.shortField"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.RecordMaker.shortField">[docs]</a>    <span class="k">def</span> <span class="nf">shortField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldMaker</span><span class="o">|</span><span class="n">ListFieldMaker</span><span class="o">|</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns FieldMaker for field.</span>

<span class="sd">        Args:</span>
<span class="sd">            field: field name to look for FieldMaker.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            The FieldMaker for the field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fieldMaker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldMakers</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">fieldMaker</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="n">field</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">fieldMaker</span></div></div>
    

<div class="viewcode-block" id="TagParserError"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParserError">[docs]</a><span class="k">class</span> <span class="nc">TagParserError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception class for errors thrown by TagParser.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fileName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rowIndex</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">columnIndex</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">endMessage</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            message: start of the message for the exception.</span>
<span class="sd">            fileName: the file name where the exception happened.</span>
<span class="sd">            sheetName: the sheet name in the Excel file where the exception happened.</span>
<span class="sd">            rowIndex: the row index in the tabular file where the exception happened.</span>
<span class="sd">            columnIndex: the column index in the tabular file where the exception happened.</span>
<span class="sd">            endMessage: the optional end of the message for the exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.xls[xm]?$&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
            <span class="n">cellName</span> <span class="o">=</span> <span class="n">TagParserError</span><span class="o">.</span><span class="n">columnName</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rowIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cellName</span> <span class="o">=</span> <span class="s2">&quot;col &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">columnIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, row &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rowIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot; at cell </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">sheetName</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">cellName</span> <span class="o">+</span> <span class="s2">&quot;]</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">endMessage</span>
        
<div class="viewcode-block" id="TagParserError.columnName"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParserError.columnName">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">columnName</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns Excel-style column name for columnIndex (integer).</span>

<span class="sd">        Args:</span>
<span class="sd">            columnIndex: index of the column in the spreadsheet.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            If columnIndex is less than 0 return &quot;:&quot;, else return the capital letter(s) of the Excel colummn, Ex: columnIndex = 3 returns &quot;D&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">columnIndex</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;:&quot;</span>
        <span class="n">dividend</span> <span class="o">=</span> <span class="n">columnIndex</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">dividend</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">modulo</span> <span class="o">=</span> <span class="p">(</span><span class="n">dividend</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">%</span> <span class="mi">26</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">65</span><span class="o">+</span><span class="n">modulo</span><span class="p">)</span> <span class="o">+</span> <span class="n">name</span>
            <span class="n">dividend</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">dividend</span> <span class="o">-</span> <span class="n">modulo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">26</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span></div>
        
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TagParser"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser">[docs]</a><span class="k">class</span> <span class="nc">TagParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates parser objects that convert tagged .xlsx worksheets into nested dictionary structures for metadata capture.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablesAndFieldsToTrack</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackedFieldsDict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">reDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;r[</span><span class="se">\&quot;</span><span class="s2">&#39;](.*)[</span><span class="se">\&quot;</span><span class="s2">&#39;]$&quot;</span><span class="p">)</span>        

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_isEmptyRow</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if row is empty.</span>

<span class="sd">        Args:</span>
<span class="sd">            row: row from a tabular file.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if each value in row is the empty string after stripping, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">xstr</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_determineTableField</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">|</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span><span class="o">|</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns table and field based on params tuple and last table and field set.</span>
<span class="sd">        </span>
<span class="sd">        If table is in params use that for table, else use self.lastTable.</span>
<span class="sd">        If field is in params use that for field, else use self.lastField.</span>
<span class="sd">        If attribute is in params add that to field.</span>

<span class="sd">        Args:</span>
<span class="sd">            params: (attribute) or (table, field) or (table, field, attribute), generally the groups from a regular expression.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            (table, field) or (table, field%attribute)</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            TagParserError: if the table or field name are undefined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">:</span>
                <span class="n">attribute</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">attribute</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">field</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Undefined table name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span> <span class="o">=</span> <span class="n">table</span>
        
        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastField</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span>
                <span class="c1">## There does not appear to be a way to get to this error from the CLI.</span>
                <span class="c1">## Any tag missing a field triggers a different error.</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Undefined field name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastField</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastField</span> <span class="o">=</span> <span class="n">field</span>

        <span class="k">if</span> <span class="n">attribute</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">table</span><span class="p">,</span> <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span> <span class="o">+</span> <span class="n">attribute</span>
        
        <span class="k">return</span> <span class="n">table</span><span class="p">,</span> <span class="n">field</span>


    <span class="n">cellSplitter</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([*=+;,]|\&quot;[^\&quot;]*\&quot;|#\w+\s*\w+\.(?:\w+\s*\w+%\w+\s*\w+|\w+\s*\w+))|\s+&#39;</span><span class="p">)</span>
    <span class="n">stringExtractor</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*)\&quot;$&#39;</span><span class="p">)</span>
    <span class="n">operatorDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[=+]&#39;</span><span class="p">)</span>
    <span class="n">wordDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">)</span>
    <span class="n">wordOnlyDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\w+$&#39;</span><span class="p">)</span>
    <span class="n">tagDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
    <span class="n">childDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#.*\</span><span class="si">%c</span><span class="s1">hild&#39;</span><span class="p">)</span>
    <span class="n">childFieldDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\w*)\</span><span class="si">%c</span><span class="s1">hild\.(\w+)$&#39;</span><span class="p">)</span>
    <span class="n">childFieldAttributeDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\w*)\</span><span class="si">%c</span><span class="s1">hild\.(\w+)\%(\w+)$&#39;</span><span class="p">)</span>
    <span class="n">emptyChildDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\w*)\</span><span class="si">%c</span><span class="s1">hild$&#39;</span><span class="p">)</span>
    <span class="n">tableFieldAttributeDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\w*)\.(\w+)\%(\w+)$&#39;</span><span class="p">)</span>
    <span class="n">tableFieldDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#([\w\s-]*)\.(\w+|\w+\.id)$&#39;</span><span class="p">)</span>
    <span class="n">attributeDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;#\%(\w+)$&#39;</span><span class="p">)</span>
    <span class="n">trackFieldDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\w*)\%track$&#39;</span><span class="p">)</span>
    <span class="n">untrackFieldDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\w*)\</span><span class="si">%u</span><span class="s1">ntrack$&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_parseHeaderCell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recordMakers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RecordMaker</span><span class="p">],</span> <span class="n">cellString</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">childWithoutID</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parses header cell and return the current state of ID inclusion of current child record.</span>
<span class="sd">        </span>
<span class="sd">        Parse cellString and modify recordMakers so they can be used later to create records.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            recordMakers: list of recordMaker objects.</span>
<span class="sd">            cellString: contents of the header cell.</span>
<span class="sd">            childWithoutID: whether the current child record has an id or not.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if the current child record does not have an id, False if it does.</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            TagParserError: If any of the tags are misformed an error will be raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">childDetector</span><span class="p">,</span> <span class="n">cellString</span><span class="p">))</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#.</span><span class="si">%c</span><span class="s2">hild tag not allowed in first column&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;#tags&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#tags only allowed in first column&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">cellSplitter</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">]</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">if</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">stringExtractor</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="p">]</span>
        
        <span class="n">assignment</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fieldMakerClass</span> <span class="o">=</span> <span class="n">FieldMaker</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># check for common errors</span>
            <span class="c1">## This cannot be triggered from the CLI with #tags in assignment. It will hit another error about #tags only being on the first column first.</span>
            <span class="k">if</span> <span class="n">assignment</span> <span class="ow">and</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;#table&#39;</span> <span class="ow">or</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;#tags&quot;</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">childDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#table, #tags, or #</span><span class="si">%c</span><span class="s2">hild tags  in assignment&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">operatorDetector</span><span class="p">,</span><span class="n">token</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">operatorDetector</span><span class="p">,</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;tandem +/= operators without intervening operand&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">wordDetector</span><span class="p">,</span><span class="n">token</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">wordDetector</span><span class="p">,</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;tandem literal/tag without intervening operator&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">operatorDetector</span><span class="p">,</span><span class="n">token</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;+/= operator without second operand&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">assignment</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;+ operator not in an assignment&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">assignment</span> <span class="ow">or</span> <span class="n">fieldMakerClass</span> <span class="o">!=</span> <span class="n">ListFieldMaker</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;, operator not in a list field assignment&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span> <span class="ow">and</span> <span class="n">assignment</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;second = operator in an assignment&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">assignment</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">tagDetector</span><span class="p">,</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;* operator is not at the beginning of a field tag&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>

                        
            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;#tags&#39;</span> <span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;#table&#39;</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;=&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">wordOnlyDetector</span><span class="p">,</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#table tag without assignment&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">emptyChildDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;child tag with no field&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">childFieldAttributeDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">childFieldDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span> <span class="p">:</span>  <span class="c1"># #table%child.field.attribute combinations</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">recordMakers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hasValidID</span><span class="p">()</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;no id field in parent record&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="n">table</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determineTableField</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">field</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;no assignment allowed with explicit child field&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span> <span class="ow">and</span> <span class="n">childWithoutID</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;second explicit non-id child field specified&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span> <span class="ow">and</span> <span class="n">childWithoutID</span> <span class="ow">and</span> <span class="n">table</span> <span class="o">!=</span> <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">table</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;second explicit non-id child field specified&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">childWithoutID</span> <span class="p">:</span>
                    <span class="n">recordMakers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RecordMaker</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">recordMakers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">table</span><span class="p">,</span> <span class="n">recordMakers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shortField</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
                <span class="c1">## As far as I can tell this error is impossible to reach from the CLI. Trying to create duplicate fields will lead to triggering one of </span>
                <span class="c1">## second explicit errors above.</span>
                <span class="k">if</span> <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isInvalidDuplicateField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fieldMakerClass</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;field </span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> specified twice in &quot;</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot; record&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fieldMakerClass</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span>
                    <span class="n">childWithoutID</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span> <span class="p">:</span>
                        <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addColumnOperand</span><span class="p">(</span><span class="n">recordMakers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shortField</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span> <span class="p">:</span>                                
                        <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addColumnOperand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">childWithoutID</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addColumnOperand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>                                
            <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">trackFieldDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Incorrectly formatted track tag, </span><span class="se">\&quot;</span><span class="s2">=</span><span class="se">\&quot;</span><span class="s2"> must follow </span><span class="se">\&quot;</span><span class="s2">track</span><span class="se">\&quot;</span><span class="s2"> and </span><span class="se">\&quot;</span><span class="s2">table.field</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">table.field</span><span class="si">%a</span><span class="s2">ttribute</span><span class="se">\&quot;</span><span class="s2"> must follow </span><span class="se">\&quot;</span><span class="s2">=</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="c1">## Munch the =.</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">nextToken</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w+\.\w+)|(\w+\.\w+%\w+)&quot;</span><span class="p">,</span> <span class="n">nextToken</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Incorrectly formatted track tag, the field or attribute to be tracked is malformed, must be </span><span class="se">\&quot;</span><span class="s2">table.field</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">table.field</span><span class="si">%a</span><span class="s2">ttribute</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">tableToAddTo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tableToAddTo</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span> <span class="o">=</span> <span class="n">tableToAddTo</span>
                    <span class="n">split</span> <span class="o">=</span> <span class="n">nextToken</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="n">fieldTable</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">fieldTable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablesAndFieldsToTrack</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tablesAndFieldsToTrack</span><span class="p">[</span><span class="n">fieldTable</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tablesAndFieldsToTrack</span><span class="p">[</span><span class="n">fieldTable</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">field</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">tableToAddTo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="p">[</span><span class="n">tableToAddTo</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nextToken</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="p">[</span><span class="n">tableToAddTo</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">nextToken</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">nextToken</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedFieldsDict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trackedFieldsDict</span><span class="p">[</span><span class="n">nextToken</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="n">tokens</span><span class="p">:</span>
                        <span class="n">nextToken</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">nextToken</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">:</span>
                            <span class="n">nextToken</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">nextToken</span> <span class="o">==</span> <span class="s2">&quot;;&quot;</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">untrackFieldDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span> <span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Incorrectly formatted untrack tag, </span><span class="se">\&quot;</span><span class="s2">=</span><span class="se">\&quot;</span><span class="s2"> must follow </span><span class="se">\&quot;</span><span class="s2">track</span><span class="se">\&quot;</span><span class="s2"> and </span><span class="se">\&quot;</span><span class="s2">table.field</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">table.field</span><span class="si">%a</span><span class="s2">ttribute</span><span class="se">\&quot;</span><span class="s2"> must follow </span><span class="se">\&quot;</span><span class="s2">=</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="c1">## Munch the =.</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">nextToken</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w+\.\w+)|(\w+\.\w+%\w+)&quot;</span><span class="p">,</span> <span class="n">nextToken</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Incorrectly formatted untrack tag, the field or attribute to be tracked is malformed, must be </span><span class="se">\&quot;</span><span class="s2">table.field</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">table.field</span><span class="si">%a</span><span class="s2">ttribute</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">tableToAddTo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tableToAddTo</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span> <span class="o">=</span> <span class="n">tableToAddTo</span>
                    <span class="n">split</span> <span class="o">=</span> <span class="n">nextToken</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="n">fieldTable</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">tableToAddTo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="p">[</span><span class="n">tableToAddTo</span><span class="p">]</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">nextToken</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="p">[</span><span class="n">tableToAddTo</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="p">[</span><span class="n">tableToAddTo</span><span class="p">]</span>
                    <span class="n">tableAndFieldInOtherTables</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">nextToken</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                            <span class="n">tableAndFieldInOtherTables</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">tableAndFieldInOtherTables</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedFieldsDict</span><span class="p">[</span><span class="n">nextToken</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tablesAndFieldsToTrack</span><span class="p">[</span><span class="n">fieldTable</span><span class="p">]</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tablesAndFieldsToTrack</span><span class="p">[</span><span class="n">fieldTable</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablesAndFieldsToTrack</span><span class="p">[</span><span class="n">fieldTable</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">tokens</span><span class="p">:</span>
                        <span class="n">nextToken</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">nextToken</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span><span class="p">:</span>
                            <span class="n">nextToken</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">nextToken</span> <span class="o">==</span> <span class="s2">&quot;;&quot;</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">tableFieldAttributeDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">tableFieldDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">attributeDetector</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span> <span class="p">:</span> <span class="c1">#table.field.attribute combinations</span>
                <span class="n">table</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determineTableField</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
                <span class="n">currentTable</span> <span class="o">=</span> <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
                <span class="k">if</span> <span class="n">currentTable</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">currentTable</span> <span class="o">!=</span> <span class="n">table</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;second table specified after first table, if trying to specify an id to another table use #.table.id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;=&#39;</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">tagDetector</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;tags without assignment in first column&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                    <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">recordMakers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addGlobalField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>                     
                <span class="k">elif</span> <span class="n">assignment</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hasField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isLastField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">field</span><span class="p">)</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;the field or attribute value used for assignment is not previously defined in record&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                    <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addVariableOperand</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isInvalidDuplicateField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fieldMakerClass</span><span class="p">)</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;field </span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> specified twice in &quot;</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s2">&quot; record&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                    <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addField</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fieldMakerClass</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span> <span class="p">:</span>
                        <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addColumnOperand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>                
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span> <span class="p">:</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="p">:</span>
                <span class="n">fieldMakerClass</span> <span class="o">=</span> <span class="n">ListFieldMaker</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="p">:</span>
                <span class="c1">## This check is done above, but this elif needs to be here to munch the + operator so it isn&#39;t added as a LiteralOperand.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">assignment</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;+ operator not in an assignment&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;,&quot;</span> <span class="p">:</span>
                <span class="c1">## This check is done above, but this elif needs to be here to munch the , operator so it isn&#39;t added as a LiteralOperand.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">assignment</span> <span class="ow">or</span> <span class="n">fieldMakerClass</span> <span class="o">!=</span> <span class="n">ListFieldMaker</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;, operator not in a list field assignment&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;;&quot;</span> <span class="p">:</span>
                <span class="n">assignment</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">fieldMakerClass</span> <span class="o">=</span> <span class="n">FieldMaker</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span><span class="n">token</span><span class="p">)</span> <span class="p">:</span> <span class="c1"># malformed tags</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;malformed or unrecognized tag </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">assignment</span> <span class="p">:</span> <span class="c1"># literals</span>
                <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addLiteralOperand</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;bad token </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="n">childWithoutID</span> 


    <span class="k">def</span> <span class="nf">_parseHeaderRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">RecordMaker</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parses header row and returns a list of RecordMakers.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            row: header row from metadata file.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            A list of RecordMakers to be used to create records.</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            TagParserError: Will raise an error if a child record does not have an id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastField</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">recordMakers</span> <span class="o">=</span> <span class="p">[</span> <span class="n">RecordMaker</span><span class="p">(),</span> <span class="n">RecordMaker</span><span class="p">()</span> <span class="p">]</span>
        <span class="n">childWithoutID</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="p">:</span>
            <span class="n">cellString</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;[*]?#&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">childWithoutID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseHeaderCell</span><span class="p">(</span><span class="n">recordMakers</span><span class="p">,</span> <span class="n">cellString</span><span class="p">,</span> <span class="n">childWithoutID</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">childWithoutID</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#.child record without id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
        
        <span class="n">recordMakers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># pop example RecordMaker used to hold global literals.    </span>
        <span class="k">return</span> <span class="n">recordMakers</span>

    
    <span class="k">def</span> <span class="nf">_parseRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recordMakers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RecordMaker</span><span class="p">],</span> <span class="n">row</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new records and add them to the nested extraction dictionary.</span>
<span class="sd">        </span>
<span class="sd">        Loop through the RecordMakers in recordMaker and add records to self.extraction </span>
<span class="sd">        based on the values in row.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            recordMakers: RecordMakers created from parsing a header row.</span>
<span class="sd">            row: row of data from a metadata file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">recordMaker</span> <span class="ow">in</span> <span class="n">recordMakers</span> <span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">recordMaker</span><span class="o">.</span><span class="n">hasValidID</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="n">table</span><span class="p">,</span><span class="n">record</span> <span class="o">=</span> <span class="n">recordMaker</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1">## Keep track of ids in specified tables.</span>
            <span class="k">if</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablesAndFieldsToTrack</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablesAndFieldsToTrack</span><span class="p">[</span><span class="n">table</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trackedFieldsDict</span><span class="p">[</span><span class="n">table</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                        
            <span class="c1">## Copy tracked fields into records if applicable.</span>
            <span class="k">if</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fieldToAdd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableRecordsToAddTo</span><span class="p">[</span><span class="n">table</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldToAdd</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedFieldsDict</span><span class="p">[</span><span class="n">fieldToAdd</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">record</span><span class="p">[</span><span class="n">fieldToAdd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackedFieldsDict</span><span class="p">[</span><span class="n">fieldToAdd</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">fieldToAdd</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trackedFieldsDict</span><span class="p">[</span><span class="n">fieldToAdd</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">fieldToAdd</span><span class="p">]</span>
            
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">record</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">record</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1">## For when the same record is on multiple tables in the tabular file.</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]][</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]][</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]][</span><span class="n">key</span><span class="p">],</span> <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">]</span>


<div class="viewcode-block" id="TagParser.parseSheet"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.parseSheet">[docs]</a>    <span class="k">def</span> <span class="nf">parseSheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts useful metadata from the worksheet and puts it in the extraction dictionary.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fileName: name of the file, used for error messages.</span>
<span class="sd">            sheetName: name of the Excel sheet, used for error messages.</span>
<span class="sd">            worksheet: the data from the file name and sheet name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastTable</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastField</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span> <span class="o">=</span> <span class="n">sheetName</span>

        
        <span class="n">tagRows</span> <span class="o">=</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;#tags&quot;</span><span class="p">)</span>
        <span class="n">ignoreRows</span> <span class="o">=</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;#ignore&quot;</span><span class="p">)</span>
        <span class="n">emptyRows</span> <span class="o">=</span> <span class="p">(</span><span class="n">worksheet</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">possibleEndOfTagGroupRows</span> <span class="o">=</span> <span class="n">emptyRows</span> <span class="o">|</span> <span class="n">tagRows</span>
        <span class="n">worksheetHeaderRows</span> <span class="o">=</span> <span class="n">worksheet</span><span class="p">[</span><span class="n">tagRows</span><span class="p">]</span>
        <span class="n">endOfTagGroupIndexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">header_index</span> <span class="ow">in</span> <span class="n">worksheetHeaderRows</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">endingIndexFound</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">possibleEndOfTagGroupRows</span><span class="p">[</span><span class="n">possibleEndOfTagGroupRows</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">header_index</span><span class="p">:</span>
                    <span class="n">endOfTagGroupIndexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">endingIndexFound</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">endingIndexFound</span><span class="p">:</span>
                <span class="n">endOfTagGroupIndexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">possibleEndOfTagGroupRows</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">headerRow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">worksheetHeaderRows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">headerRowIndex</span> <span class="o">=</span> <span class="n">worksheetHeaderRows</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">headerRow</span><span class="p">,:]</span><span class="o">.</span><span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">=</span> <span class="n">headerRowIndex</span>
            <span class="n">recordMakers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseHeaderRow</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">headerRowIndex</span><span class="p">,</span> <span class="p">:])</span>
            <span class="c1">## recordMakers should only ever be either 1 or 2 in size. If 2 then </span>
            <span class="c1">## it is a child record and the first recordMaker is just making the </span>
            <span class="c1">## parent record using the child&#39;s indicated id.</span>
            <span class="c1">## If there is not validID print a message unless there are no fieldMakers, then assume it is a control flow header row. </span>
            <span class="c1">## For example a row that just turns tracking on or off.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hasValidID</span><span class="p">()</span> <span class="ow">and</span> <span class="n">recordMakers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fieldMakers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The header row at index &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">headerRowIndex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; in the compiled export sheet does not have an </span><span class="se">\&quot;</span><span class="s2">id</span><span class="se">\&quot;</span><span class="s2"> tag, so it will not be in the JSON output.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">rowsToParse</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">headerRowIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">endOfTagGroupIndexes</span><span class="p">[</span><span class="n">headerRow</span><span class="p">])]</span>
            <span class="n">rowsToParse</span> <span class="o">=</span> <span class="n">ignoreRows</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rowsToParse</span><span class="p">][</span><span class="o">~</span><span class="n">ignoreRows</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">rowsToParse</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parseRow</span><span class="p">(</span><span class="n">recordMakers</span><span class="p">,</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>


<div class="viewcode-block" id="TagParser.loadSheet"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.loadSheet">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">loadSheet</span><span class="p">(</span><span class="n">fileName</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="n">TextIO</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">removeRegex</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">isDefaultSearch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span><span class="o">|</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load and return worksheet as a pandas data frame.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fileName: filename or sys.stdin to read a csv from stdin.</span>
<span class="sd">            sheeName: sheet name for an Excel file, ignored if not an Excel file. Can be a regular expression to search for a sheet.</span>
<span class="sd">            removeRegex: a string to pass to DataFrame.replace() to replace characters with an empty string in the dataframe that is read in. </span>
<span class="sd">                         Can be a regex. Set to None to not replace anything.</span>
<span class="sd">            isDefaultSearch: whether or not the sheetName is using default values, determines whether to print some messages.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            None if the worksheet is empty, else (fileName, sheetName, dataFrame)</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            Exception: If fileName is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">isGoogleSheetsFile</span> <span class="o">=</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">isGoogleSheetsFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.*\.xls[xm]?)$&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)))</span> <span class="ow">or</span> <span class="n">isGoogleSheetsFile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isGoogleSheetsFile</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">workbook</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">ExcelFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The Google Sheets file </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> does not exist or the URL is malformed.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                
                <span class="c1">## Convert the sheetname to a regular expression pattern so users can specify a sheetname using a regular expression.</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">):</span>
                    <span class="n">sheetDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sheetDetector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">sheetName</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">sheetName</span> <span class="ow">in</span> <span class="n">workbook</span><span class="o">.</span><span class="n">sheet_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">sheetDetector</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dataFrame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">workbook</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">converters</span> <span class="o">=</span> <span class="p">{</span><span class="n">column</span><span class="p">:</span><span class="nb">str</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">dataFrame</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
                        <span class="n">dataFrame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">workbook</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">converters</span><span class="o">=</span><span class="n">converters</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataFrame</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">isGoogleSheetsFile</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There is no data in the sheet, &quot;</span> <span class="o">+</span> <span class="n">sheetName</span> <span class="o">+</span> \
                                      <span class="s2">&quot;, of the Google Sheets file </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There is no data in worksheet </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">sheetName</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1">## Empty cells are read in as nan by default, replace with empty string.</span>
                            <span class="n">dataFrame</span> <span class="o">=</span> <span class="n">dataFrame</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">removeRegex</span><span class="p">:</span>
                                <span class="n">dataFrame</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">removeRegex</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">return</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">,</span> <span class="n">dataFrame</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isDefaultSearch</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;r&#39;&quot;</span> <span class="o">+</span> <span class="n">sheetDetector</span><span class="o">.</span><span class="n">pattern</span> <span class="o">+</span> <span class="s2">&quot;&#39; did not match any sheets in </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Excel workbook </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> does not exist.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.csv$&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataFrame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">pandas</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">EmptyDataError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There is no data in csv file </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## I don&#39;t think there is a way to read in a csv file with no length. All my attempts resulted in an error.</span>
                    <span class="c1">## Thus this is not testable from the CLI.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataFrame</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There is no data in csv file </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dataFrame</span> <span class="o">=</span> <span class="n">dataFrame</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Empty cells are read in as nan by default. Therefore replace with empty string.</span>
                        <span class="k">if</span> <span class="n">removeRegex</span><span class="p">:</span>
                            <span class="n">dataFrame</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">removeRegex</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">sheetName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sheetName</span> <span class="k">else</span> <span class="n">sheetName</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">,</span> <span class="n">dataFrame</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The csv file </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> does not exist.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid worksheet identifier </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> passed into function.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TagParser.hasFileExtension"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.hasFileExtension">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">hasFileExtension</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests whether the string has a file extension.</span>

<span class="sd">        Args:</span>
<span class="sd">            string: string to test.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if .xls, .xlsx, .xlsm, .csv, or .json is in string, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;.xls&quot;</span> <span class="ow">in</span> <span class="n">string</span> <span class="ow">or</span> <span class="s2">&quot;.xlsx&quot;</span> <span class="ow">in</span> <span class="n">string</span> <span class="ow">or</span> <span class="s2">&quot;.xlsm&quot;</span> <span class="ow">in</span> <span class="n">string</span> <span class="ow">or</span> <span class="s2">&quot;.csv&quot;</span> <span class="ow">in</span> <span class="n">string</span> <span class="ow">or</span> <span class="s2">&quot;.json&quot;</span> <span class="ow">in</span> <span class="n">string</span></div>
    
<div class="viewcode-block" id="TagParser.isGoogleSheetsFile"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.isGoogleSheetsFile">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">isGoogleSheetsFile</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests whether the string is a Google Sheets URL.</span>

<span class="sd">        Args:</span>
<span class="sd">            string: string to test.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if docs.google.com/spreadsheets/d/ is in string, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;docs.google.com/spreadsheets/d/&quot;</span> <span class="ow">in</span> <span class="n">string</span> <span class="k">else</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="TagParser.readMetadata"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.readMetadata">[docs]</a>    <span class="k">def</span> <span class="nf">readMetadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">automationSource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">automateDefaulted</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">modificationSource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">modifyDefaulted</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">removeRegex</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">,</span> <span class="n">saveExtension</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reads metadata from source.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            metadataSource: file path to metadata file with possibly a sheetname if appropriate.</span>
<span class="sd">            automationSource: file path to automation file or a sheetname.</span>
<span class="sd">            automateDefaulted: whether the automation source is the default value or not, passed to readDirectives for message printing.</span>
<span class="sd">            modificationSource: file path to modification file or a sheetname.</span>
<span class="sd">            modificationDefaulted: whether the modification source is the default value or not, passed to readDirectives for message printing.</span>
<span class="sd">            removeRegex: a string to pass to DataFrame.replace() to replace characters with an empty string in the dataframe that is read in. </span>
<span class="sd">                         Can be a regex. Set to None to not replace anything. Passed to loadSheet and readDirectives.</span>
<span class="sd">            saveExtension: if &quot;csv&quot; saves the export as a csv file, else saves it as an Excel file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## If automation source is just a sheet name then see if metadata source is an Excel or Google Sheets file.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">hasFileExtension</span><span class="p">(</span><span class="n">automationSource</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">isGoogleSheetsFile</span><span class="p">(</span><span class="n">automationSource</span><span class="p">):</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.*\.xls[xm]?)&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">)):</span>
                   <span class="n">automationFilePath</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
                   <span class="n">automationSheetName</span> <span class="o">=</span> <span class="n">automationSource</span>
               <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/.*$&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">)):</span>
                   <span class="n">automationFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
                   <span class="n">automationSheetName</span> <span class="o">=</span> <span class="n">automationSource</span>
               <span class="k">else</span><span class="p">:</span>
                   <span class="n">automationFilePath</span> <span class="o">=</span> <span class="n">automationSource</span>
                   <span class="n">automationSheetName</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.xls[xm]?$&quot;</span><span class="p">,</span> <span class="n">automationSource</span><span class="p">):</span>
            <span class="n">automationFilePath</span> <span class="o">=</span> <span class="n">automationSource</span>
            <span class="n">automationSheetName</span> <span class="o">=</span> <span class="s2">&quot;#automate&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.*\.xls[xm]?):(.*)$&quot;</span><span class="p">,</span> <span class="n">automationSource</span><span class="p">)):</span>
            <span class="n">automationFilePath</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">automationSheetName</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/[^:]*$&quot;</span><span class="p">,</span> <span class="n">automationSource</span><span class="p">)):</span>
            <span class="n">automationFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
            <span class="n">automationSheetName</span> <span class="o">=</span> <span class="s2">&quot;#automate&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/.*:(.*)$&quot;</span><span class="p">,</span> <span class="n">automationSource</span><span class="p">)):</span>
            <span class="n">automationFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
            <span class="n">automationSheetName</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">automationFilePath</span> <span class="o">=</span> <span class="n">automationSource</span>
            <span class="n">automationSheetName</span> <span class="o">=</span> <span class="kc">None</span>
                    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">hasFileExtension</span><span class="p">(</span><span class="n">modificationSource</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">isGoogleSheetsFile</span><span class="p">(</span><span class="n">modificationSource</span><span class="p">):</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.*\.xls[xm]?)&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">)):</span>
                   <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
                   <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="n">modificationSource</span>
               <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/.*$&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">)):</span>
                   <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
                   <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="n">modificationSource</span>
               <span class="k">else</span><span class="p">:</span>
                   <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">modificationSource</span>
                   <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.xls[xm]?$&quot;</span><span class="p">,</span> <span class="n">modificationSource</span><span class="p">):</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">modificationSource</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="s2">&quot;#modify&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.*\.xls[xm]?):(.*)$&quot;</span><span class="p">,</span> <span class="n">modificationSource</span><span class="p">)):</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/[^:]*$&quot;</span><span class="p">,</span> <span class="n">modificationSource</span><span class="p">)):</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="s2">&quot;#modify&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/.*:(.*)$&quot;</span><span class="p">,</span> <span class="n">modificationSource</span><span class="p">)):</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modificationFilePath</span> <span class="o">=</span> <span class="n">modificationSource</span>
            <span class="n">modificationSheetName</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.xls[xm]?$&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">):</span>
            <span class="n">metadataFilePath</span> <span class="o">=</span> <span class="n">metadataSource</span>
            <span class="n">metadataSheetName</span> <span class="o">=</span> <span class="s2">&quot;#export&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.*\.xls[xm]?):(.*)$&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">)):</span>
            <span class="n">metadataFilePath</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">metadataSheetName</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/[^:]*$&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">)):</span>
            <span class="n">metadataFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
            <span class="n">metadataSheetName</span> <span class="o">=</span> <span class="s2">&quot;#export&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/.*:(.*)$&quot;</span><span class="p">,</span> <span class="n">metadataSource</span><span class="p">)):</span>
            <span class="n">metadataFilePath</span> <span class="o">=</span> <span class="s2">&quot;https://docs.google.com/spreadsheets/d/&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/export?format=xlsx&quot;</span>
            <span class="n">metadataSheetName</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadataFilePath</span> <span class="o">=</span> <span class="n">metadataSource</span>
            <span class="n">metadataSheetName</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">hasFileExtension</span><span class="p">(</span><span class="n">automationFilePath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">isGoogleSheetsFile</span><span class="p">(</span><span class="n">automationFilePath</span><span class="p">):</span>
            <span class="n">automationDirectives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDirectives</span><span class="p">(</span><span class="n">automationFilePath</span><span class="p">,</span> <span class="n">automationSheetName</span><span class="p">,</span> <span class="s2">&quot;automation&quot;</span><span class="p">,</span> <span class="n">removeRegex</span><span class="p">,</span> <span class="n">automateDefaulted</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">automationDirectives</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">## Structure of modificationDirectives: {table_key:{field_key:{comparison_type:{field_value:{directive:{field_key:directive_value}}}}}} </span>
        <span class="c1">## The directive value is the new value to give the field or regex, regex is a list, assign is a string.</span>
        <span class="c1">## unique is handled by having &quot;-unique&quot; added to comparison type key, so there is &quot;exact-unique&quot; and &quot;exact&quot;.</span>
        <span class="k">if</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">hasFileExtension</span><span class="p">(</span><span class="n">modificationFilePath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">isGoogleSheetsFile</span><span class="p">(</span><span class="n">modificationFilePath</span><span class="p">):</span>
            <span class="n">modificationDirectives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDirectives</span><span class="p">(</span><span class="n">modificationFilePath</span><span class="p">,</span> <span class="n">modificationSheetName</span><span class="p">,</span> <span class="s2">&quot;modification&quot;</span><span class="p">,</span> <span class="n">removeRegex</span><span class="p">,</span> <span class="n">modifyDefaulted</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modificationDirectives</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.json$&quot;</span><span class="p">,</span> <span class="n">metadataFilePath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadataFilePath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span><span class="p">:</span>
                <span class="n">newMetadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonFile</span><span class="p">)</span>
            <span class="n">currentMetadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span> <span class="o">=</span> <span class="n">newMetadata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">currentMetadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span>
            <span class="n">newMetadata</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span> <span class="o">=</span> <span class="n">newMetadata</span>
            <span class="n">dataFrameTuple</span> <span class="o">=</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">loadSheet</span><span class="p">(</span><span class="n">metadataFilePath</span><span class="p">,</span> <span class="n">metadataSheetName</span><span class="p">,</span> <span class="n">removeRegex</span><span class="o">=</span><span class="n">removeRegex</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dataFrameTuple</span><span class="p">:</span>
                <span class="n">dataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagSheet</span><span class="p">(</span><span class="n">automationDirectives</span><span class="p">,</span> <span class="n">dataFrameTuple</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">silent</span><span class="p">)</span>
                <span class="n">dataFrameTuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataFrameTuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataFrameTuple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dataFrame</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">saveExtension</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">saveSheet</span><span class="p">(</span><span class="o">*</span><span class="n">dataFrameTuple</span><span class="p">,</span> <span class="n">saveExtension</span><span class="p">)</span>

                <span class="c1">## Ultimately modifies self.extraction.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parseSheet</span><span class="p">(</span><span class="o">*</span><span class="n">dataFrameTuple</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span><span class="n">modificationDirectives</span><span class="p">)</span>

        <span class="n">newMetadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span> <span class="o">=</span> <span class="n">currentMetadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">newMetadata</span><span class="p">)</span></div>


<div class="viewcode-block" id="TagParser.saveSheet"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.saveSheet">[docs]</a>    <span class="k">def</span> <span class="nf">saveSheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">saveExtension</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save given worksheet in the given format.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fileName: file name or path to save to.</span>
<span class="sd">            sheetName: name to give the sheet if saving as Excel.</span>
<span class="sd">            worksheet: data to save.</span>
<span class="sd">            saveExtension: if &quot;csv&quot; save as csv file, else save as Excel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">baseName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">baseName</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_export.&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;docs.google.com/spreadsheets/d/([^/]*)/[^:]*$&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)):</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;Google_Sheets_&quot;</span> <span class="o">+</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_export.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;stdin_export.&quot;</span>
        <span class="k">if</span> <span class="n">saveExtension</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">+=</span> <span class="s2">&quot;csv&quot;</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">+=</span> <span class="s2">&quot;xlsx&quot;</span>
            <span class="k">with</span> <span class="n">pandas</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">engine</span> <span class="o">=</span> <span class="s2">&quot;xlsxwriter&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">sheetName</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="n">headerSplitter</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[+]|(r?\&quot;[^\&quot;]*\&quot;|r?</span><span class="se">\&#39;</span><span class="s1">[^</span><span class="se">\&#39;</span><span class="s1">]*</span><span class="se">\&#39;</span><span class="s1">)|\s+&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="TagParser.tagSheet"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.tagSheet">[docs]</a>    <span class="k">def</span> <span class="nf">tagSheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">automationDirectives</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tags to the worksheet using the given automation directives.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            automationDirectives: a dictionary used to place the tags in the appropriate places.</span>
<span class="sd">            worksheet: the DataFrame in which to place the tags.</span>
<span class="sd">            silent: if True don&#39;t print warnings.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            The modified worksheet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">worksheet</span><span class="p">,</span> <span class="n">wasAutomationDirectiveUsed</span> <span class="o">=</span> <span class="n">cythonized_tagSheet</span><span class="o">.</span><span class="n">tagSheet</span><span class="p">(</span><span class="n">automationDirectives</span><span class="p">,</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">silent</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">directive</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wasAutomationDirectiveUsed</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">directive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Automation directive number &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; was never used.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        <span class="n">worksheet</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">worksheet</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">worksheet</span></div>

    <span class="n">modificationComparisonTypes</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;exact&quot;</span><span class="p">,</span> <span class="s2">&quot;regex&quot;</span><span class="p">,</span> <span class="s2">&quot;levenshtein&quot;</span> <span class="p">]</span>
    <span class="n">matchTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;first-nowarn&quot;</span><span class="p">,</span> <span class="s2">&quot;unique&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_parseModificationSheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts modification directives from a given worksheet.</span>

<span class="sd">        &quot;modification&quot; : { table : { field :  { &quot;(exact|regex|levenshtein)\-(first|first\-nowarn|unique|all)&quot; :</span>
<span class="sd">                          { field_value : { &quot;assign&quot; : { field : value,... }, &quot;append&quot; : { field : value,... }, &quot;prepend&quot; : { field : value,... },</span>
<span class="sd">                                            &quot;regex&quot; : { field : regex_pair,... }, &quot;delete&quot; : [ field,... ], &quot;rename&quot; : { old_field : new_field } } } } } }</span>
<span class="sd">        </span>
<span class="sd">        Loops over worksheet and builds up self.modificationDirectives.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fileName: used for printing more descriptive error messages.</span>
<span class="sd">            sheetName: used for printing more descriptive error messages.</span>
<span class="sd">            worksheet: data used to build the modification directives.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            TagParserError: usually raised for malformed tags, but also for other unpredicted errors</span>
<span class="sd">            Exception: a catch all in case something unforeseen happens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span> <span class="o">=</span> <span class="n">sheetName</span>
        
        <span class="n">aColumn</span> <span class="o">=</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">parsing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aColumn</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;#tags$&#39;</span><span class="p">,</span> <span class="n">xstr</span><span class="p">(</span><span class="n">aColumn</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                    <span class="n">parsing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">valueIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">comparisonIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">comparisonType</span> <span class="o">=</span> <span class="s2">&quot;regex|exact&quot;</span>
                    <span class="n">userSpecifiedType</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">matchType</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span>
                    <span class="n">matchIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">assignIndeces</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">assignFields</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">assignFieldTypes</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">appendIndeces</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">appendFields</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">appendFieldTypes</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">prependIndeces</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">prependFields</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">prependFieldTypes</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">regexIndeces</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">regexFields</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">deletionFields</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">renameFieldMap</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="p">:])):</span>
                        <span class="n">cellString</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#(\w+)\.(\w+|\w+%\w+|\w+\.id)\.value\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="n">valueIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span>
                            <span class="n">table</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">fieldID</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#(\w+)?\.(\w+|\w+%\w+|\w+\.id)\.delete\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">valueIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#table_name.field_name.delete in column before #table_name.field_name.value&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">table</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Table name does not match between #table_name.field_name.value and #table_name.field_name.delete modification tags&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">deletionFields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#(\w+)?\.(\w+|\w+%\w+|\w+\.id)\.rename\.(\w+|\w+%\w+|\w+\.id)\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">valueIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#table_name.field_name.rename in column before #table_name.field_name.value&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">table</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Table name does not match between #table_name.field_name.value and #table_name.field_name.rename modification tags&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;rename modification directive renames the field to the same name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Not allowed to rename </span><span class="se">\&quot;</span><span class="s2">id</span><span class="se">\&quot;</span><span class="s2"> fields&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">renameFieldMap</span><span class="p">[</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#(\w+)?\.(\w+|\w+%\w+|\w+\.id)\.rename\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Incorrect rename directive format.  Should be #[table_name].field_name.rename.new_field_name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*(\*#|#)(\w+)?\.(\w+)\.assign\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*(#)(\w+)?\.(\w+|\w+%\w+|\w+\.id)\.assign\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">valueIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#table_name.field_name.assign in column before #table_name.field_name.value&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">table</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Table name does not match between #table_name.field_name.value and #table_name.field_name.assign modification tags&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">assignIndeces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">assignFieldTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                            <span class="n">assignFields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*(\*#|#)(\w+)?\.(\w+)\.append\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*(#)(\w+)?\.(\w+|\w+%\w+|\w+\.id)\.append\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">valueIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#table_name.field_name.append in column before #table_name.field_name.value&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">table</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Table name does not match between #table_name.field_name.value and #table_name.field_name.append modification tags&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">appendIndeces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">appendFieldTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                            <span class="n">appendFields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*(\*#|#)(\w+)?\.(\w+)\.prepend\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*(#)(\w+)?\.(\w+|\w+%\w+|\w+\.id)\.prepend\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">valueIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#table_name.field_name.prepend in column before #table_name.field_name.value&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">table</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Table name does not match between #table_name.field_name.value and #table_name.field_name.prepend modification tags&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">prependIndeces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">prependFieldTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                            <span class="n">prependFields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#(\w+)?\.(\w+)\.regex\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#(\w+)?\.(\w+|\w+%\w+|\w+\.id)\.regex\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">valueIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#table_name.field_name.regex in column before #table_name.field_name.value&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">table</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Table name does not match between #table_name.field_name.value and #table_name.field_name.regex modification tags&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">regexIndeces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                            <span class="n">regexFields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#comparison\s*=\s*(exact|regex|regex\|exact|levenshtein)\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="n">comparisonType</span><span class="o">=</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">userSpecifiedType</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#comparison\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">):</span>
                            <span class="n">comparisonIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span>
                        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#match\s*=.*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#match\s*=\s*(first|first-nowarn|unique|all)\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                                <span class="n">matchType</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">badType</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#match\s*=(.*)$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Unknown match type </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">badType</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#match\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">):</span>
                            <span class="n">matchIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">valueIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assignIndeces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">appendIndeces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prependIndeces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">regexIndeces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">deletionFields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">renameFieldMap</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Missing #table_name.field_name.value or #.field_name.assign|append|prepend|regex|delete|rename modification tags&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">deletionFields</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Not allowed to delete </span><span class="se">\&quot;</span><span class="s2">id</span><span class="se">\&quot;</span><span class="s2"> fields&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;#ignore$&#39;</span><span class="p">,</span> <span class="n">xstr</span><span class="p">(</span><span class="n">aColumn</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">_isEmptyRow</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="p">:]):</span>
                    <span class="n">parsing</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">parsing</span><span class="p">:</span>
                    <span class="n">fieldValue</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">valueIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">comparisonIndex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">comparisonString</span> <span class="o">:=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">comparisonIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="ow">in</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">modificationComparisonTypes</span><span class="p">:</span>
                        <span class="n">localComparisonType</span> <span class="o">=</span> <span class="n">comparisonString</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">userSpecifiedType</span> <span class="ow">or</span> <span class="n">comparisonType</span> <span class="o">==</span> <span class="s2">&quot;regex|exact&quot;</span><span class="p">:</span>
                            <span class="n">localComparisonType</span> <span class="o">=</span> <span class="s2">&quot;regex&quot;</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">fieldValue</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;exact&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">localComparisonType</span> <span class="o">=</span> <span class="n">comparisonType</span>
                    
                    <span class="k">if</span> <span class="n">localComparisonType</span> <span class="o">==</span> <span class="s2">&quot;regex&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">fieldValue</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Comparison type is indicated as regex, but comparison value is not a regex&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">valueIndex</span><span class="p">,</span> <span class="s2">&quot; This modification will be skipped.&quot;</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                        <span class="c1"># raise TagParserError(&quot;Comparison type is indicated as regex, but comparison value is not a regex&quot;, self.fileName, self.sheetName, self.rowIndex, valueIndex)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">matchIndex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">matchType</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">matchIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">matchType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">matchTypes</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Unknown match type </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">matchType</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">matchIndex</span><span class="p">)</span>
                    <span class="n">localComparisonType</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">matchType</span>

                    <span class="n">assignFieldMap</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assignIndeces</span><span class="p">)):</span>
                        <span class="n">assignFieldValue</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">assignIndeces</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*&quot;</span><span class="p">,</span> <span class="n">assignFieldTypes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Evaluator</span><span class="o">.</span><span class="n">isEvalString</span><span class="p">(</span><span class="n">assignFieldValue</span><span class="p">):</span>
                            <span class="c1">## If the list field contains semicolons use it to split instead of commas.</span>
                            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*;.*&quot;</span><span class="p">,</span> <span class="n">assignFieldValue</span><span class="p">):</span>
                                <span class="n">assignFieldValue</span> <span class="o">=</span> <span class="n">assignFieldValue</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">assignFieldValue</span> <span class="o">=</span> <span class="n">assignFieldValue</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

                        <span class="n">assignFieldMap</span><span class="p">[</span><span class="n">assignFields</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">assignFieldValue</span>

                    <span class="n">appendFieldMap</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">appendIndeces</span><span class="p">)):</span>
                        <span class="n">appendFieldValue</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">appendIndeces</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*&quot;</span><span class="p">,</span> <span class="n">appendFieldTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                            <span class="c1">## If the list field contains semicolons use it to split instead of commas.</span>
                            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*;.*&quot;</span><span class="p">,</span> <span class="n">appendFieldValue</span><span class="p">):</span>
                                <span class="n">appendFieldValue</span> <span class="o">=</span> <span class="n">appendFieldValue</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">appendFieldValue</span> <span class="o">=</span> <span class="n">appendFieldValue</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

                        <span class="n">appendFieldMap</span><span class="p">[</span><span class="n">appendFields</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">appendFieldValue</span>

                    <span class="n">prependFieldMap</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prependIndeces</span><span class="p">)):</span>
                        <span class="n">prependFieldValue</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">prependIndeces</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*&quot;</span><span class="p">,</span> <span class="n">prependFieldTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                            <span class="c1">## If the list field contains semicolons use it to split instead of commas.</span>
                            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*;.*&quot;</span><span class="p">,</span> <span class="n">prependFieldValue</span><span class="p">):</span>
                                <span class="n">prependFieldValue</span> <span class="o">=</span> <span class="n">prependFieldValue</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">prependFieldValue</span> <span class="o">=</span> <span class="n">prependFieldValue</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

                        <span class="n">prependFieldMap</span><span class="p">[</span><span class="n">prependFields</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">prependFieldValue</span>

                    <span class="n">regexFieldMap</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regexIndeces</span><span class="p">)):</span>
                        <span class="n">regexFieldValue</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">regexIndeces</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(r[</span><span class="se">\&quot;</span><span class="s2">&#39;].*[</span><span class="se">\&quot;</span><span class="s2">&#39;])\s*,\s*(r[</span><span class="se">\&quot;</span><span class="s2">&#39;].*[</span><span class="se">\&quot;</span><span class="s2">&#39;])$&quot;</span><span class="p">,</span><span class="n">regexFieldValue</span><span class="p">)):</span>
                            <span class="n">regexFieldMap</span><span class="p">[</span><span class="n">regexFields</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;#table_name.field_name.regex value is not of the correct format r</span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;</span><span class="s2">,r</span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">valueIndex</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">localComparisonType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldValue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># elif not silent:</span>
                    <span class="c1">#     print(TagParserError(&quot;Warning: duplicate modification directive given&quot;, self.fileName, self.sheetName, self.rowIndex, self.columnIndex), file=sys.stderr)</span>
                    <span class="k">if</span> <span class="n">assignFieldMap</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;assign&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">]:</span>
                            <span class="c1">## If any of the keys in assignFieldMap are already in modificationDirectives then it is a duplicate assign modification.</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;assign&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">assignFieldMap</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Warning: duplicate assign modification directive given&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;assign&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">assignFieldMap</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;assign&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assignFieldMap</span>
                    <span class="k">if</span> <span class="n">appendFieldMap</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;append&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">]:</span>
                            <span class="c1">## If any of the keys in appendFieldMap are already in modificationDirectives then it is a duplicate append modification.</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;append&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">appendFieldMap</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Warning: duplicate append modification directive given&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;append&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">appendFieldMap</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;append&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">appendFieldMap</span>
                    <span class="k">if</span> <span class="n">prependFieldMap</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;prepend&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">]:</span>
                            <span class="c1">## If any of the keys in prependFieldMap are already in modificationDirectives then it is a duplicate prepend modification.</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;prepend&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">prependFieldMap</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Warning: duplicate prepend modification directive given&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;prepend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">prependFieldMap</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;prepend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prependFieldMap</span>
                    <span class="k">if</span> <span class="n">regexFieldMap</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;regex&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">]:</span>
                            <span class="c1">## If any of the keys in regexFieldMap are already in modificationDirectives then it is a duplicate regex modification.</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">regexFieldMap</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Warning: duplicate regex modification directive given&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">regexFieldMap</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regexFieldMap</span>
                    <span class="k">if</span> <span class="n">deletionFields</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">]:</span>
                            <span class="c1">## If any of fields in deletionFields are already in modificationDirectives then it is a duplicate delete modification.</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;delete&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">deletionFields</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Warning: duplicate delete modification directive given&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;delete&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">deletionFields</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deletionFields</span>
                    <span class="k">if</span> <span class="n">renameFieldMap</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;rename&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">]:</span>
                            <span class="c1">## If any of the keys in renameFieldMap are already in modificationDirectives then it is a duplicate rename modification.</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;rename&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">renameFieldMap</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Warning: duplicate rename modification directive given&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;rename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">renameFieldMap</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">fieldID</span><span class="p">][</span><span class="n">localComparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;rename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">renameFieldMap</span>
            <span class="k">except</span> <span class="n">TagParserError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">## I don&#39;t think this can be triggered from the CLI.</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Internal Parser Error&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_parseAutomationSheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts automation directives from a given worksheet.</span>

<span class="sd">        &quot;automation&quot; : [ { &quot;header_tag_descriptions&quot; : [ { &quot;header&quot; : column_description, &quot;tag&quot; : tag_description, &quot;required&quot; : true|false } ],   &quot;exclusion_test&quot; : exclusion_value, &quot;insert&quot; : [ [ cell_content, ... ] ] } ]</span>
<span class="sd">            </span>
<span class="sd">        Loops over worksheet and builds up self.automationDirectives.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fileName: used for printing more descriptive error messages.</span>
<span class="sd">            sheetName: used for printing more descriptive error messages.</span>
<span class="sd">            worksheet: data used to build the automation directives.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TagParserError: usually raised for malformed tags, but also for other unpredicted errors</span>
<span class="sd">            Exception: a catch all in case something unforeseen happens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span> <span class="o">=</span> <span class="n">sheetName</span>

        <span class="n">aColumn</span> <span class="o">=</span> <span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">parsing</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">currAutomationGroup</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">aColumn</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;#tags$&#39;</span><span class="p">,</span> <span class="n">xstr</span><span class="p">(</span><span class="n">aColumn</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                    <span class="n">parsing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">headerIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">tagIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">usedHeaders</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="c1">## If #tags group is twice in a row remove it from the directives.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span> <span class="ow">and</span> <span class="s2">&quot;header_tag_descriptions&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;header_tag_descriptions&quot;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">currAutomationGroup</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;header_tag_descriptions&quot;</span> <span class="p">:</span> <span class="p">[]</span> <span class="p">}</span>
                    <span class="n">requiredIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currAutomationGroup</span><span class="p">)</span>
                    <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="p">:])):</span>
                        <span class="n">cellString</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#header\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">):</span>
                            <span class="n">headerIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span>
                        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#add\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">):</span>
                            <span class="n">tagIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span>
                        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#required\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">):</span>
                            <span class="n">requiredIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#exclude\s*=\s*(.+)\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">)):</span>
                            <span class="n">currAutomationGroup</span><span class="p">[</span><span class="s2">&quot;exclusion_test&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">headerIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Missing #header tag&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tagIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Missing #add tag&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;#ignore$&#39;</span><span class="p">,</span> <span class="n">xstr</span><span class="p">(</span><span class="n">aColumn</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;#insert$&#39;</span><span class="p">,</span> <span class="n">xstr</span><span class="p">(</span><span class="n">aColumn</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                    <span class="c1">## If #insert is found inside of #tags then it needs to be added to the current tag group, otherwise make a new one.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">parsing</span><span class="p">:</span>
                        <span class="n">currAutomationGroup</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currAutomationGroup</span><span class="p">)</span>
                    <span class="c1">## If &quot;insert&quot; is already in the current automation group then add to it and don&#39;t overwrite it.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;insert&quot;</span> <span class="ow">in</span> <span class="n">currAutomationGroup</span><span class="p">:</span>
                        <span class="n">currAutomationGroup</span><span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">currAutomationGroup</span><span class="p">[</span><span class="s2">&quot;insert_multiple&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="p">:])):</span>
                            <span class="n">cellString</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#multiple\s*=\s*[Tt]rue\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">):</span>
                                <span class="n">currAutomationGroup</span><span class="p">[</span><span class="s2">&quot;insert_multiple&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;\s*#multiple\s*=\s*[Ff]alse\s*$&#39;</span><span class="p">,</span> <span class="n">cellString</span><span class="p">):</span>
                                <span class="n">currAutomationGroup</span><span class="p">[</span><span class="s2">&quot;insert_multiple&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">endTagFound</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">aColumn</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;#end$&#39;</span><span class="p">,</span> <span class="n">xstr</span><span class="p">(</span><span class="n">aColumn</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                            <span class="n">endTagFound</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                        <span class="n">currAutomationGroup</span><span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="p">:]))])</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">endTagFound</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Missing #end tag&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">_isEmptyRow</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="p">:]):</span>
                    <span class="n">parsing</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">parsing</span><span class="p">:</span>
                    <span class="n">headerValue</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">headerIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">newTagValue</span> <span class="o">=</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">tagIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">localRequired</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">requiredIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[Tt]rue$&quot;</span><span class="p">,</span> <span class="n">xstr</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">requiredIndex</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">else</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">headerValue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usedHeaders</span><span class="p">:</span>
                        <span class="n">usedHeaders</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">headerValue</span><span class="p">)</span>
                        <span class="n">currAutomationGroup</span><span class="p">[</span><span class="s2">&quot;header_tag_descriptions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s2">&quot;header&quot;</span> <span class="p">:</span> <span class="n">headerValue</span><span class="p">,</span> <span class="s2">&quot;tag&quot;</span> <span class="p">:</span> <span class="n">newTagValue</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span> <span class="p">:</span> <span class="n">localRequired</span> <span class="p">})</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Warning: duplicate header description provided in automation directive&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">TagParserError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">## Not sure you can get to this from the CLI.</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">TagParserError</span><span class="p">(</span><span class="s2">&quot;Internal Parser Error&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheetName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columnIndex</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1">## I&#39;m not sure what this was testing for, presumably empty directives need to be removed.</span>
<span class="c1">#        if self.automationDirectives and not self.automationDirectives[-1][&quot;header_tag_descriptions&quot;]:</span>
<span class="c1">#            self.automationDirectives.pop()</span>
        
        <span class="c1">## Only keep non empty directives.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span> <span class="o">=</span> <span class="p">[</span><span class="n">directive</span> <span class="k">for</span> <span class="n">directive</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span> <span class="k">if</span> <span class="s2">&quot;header_tag_descriptions&quot;</span> <span class="ow">in</span> <span class="n">directive</span> <span class="ow">and</span> <span class="n">directive</span><span class="p">[</span><span class="s2">&quot;header_tag_descriptions&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s2">&quot;header_tag_descriptions&quot;</span> <span class="ow">in</span> <span class="n">directive</span><span class="p">]</span>
        

        <span class="bp">self</span><span class="o">.</span><span class="n">rowIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<div class="viewcode-block" id="TagParser.readDirectives"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.readDirectives">[docs]</a>    <span class="k">def</span> <span class="nf">readDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">directiveType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">removeRegex</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">,</span> <span class="n">isDefaultSearch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read directives source of a given directive type.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            source: file path.</span>
<span class="sd">            sheetName: sheet name for an Excel file, ignored if not an Excel file.</span>
<span class="sd">            directiveType: either &quot;modification&quot; or &quot;automation&quot; to call the correct parsing function.</span>
<span class="sd">            removeRegex: a string to pass to DataFrame.replace() to replace characters with an empty string in the dataframe that is read in. </span>
<span class="sd">                         Can be a regex. Set to None to not replace anything. Passed to loadSheet.</span>
<span class="sd">            isDefaultSearch: whether or not the source is using default values, passed to loadSheet for message printing.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The directives that were read in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">directives</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.json$&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span><span class="p">:</span>
                <span class="n">directives</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonFile</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">directives</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="n">directiveType</span> <span class="ow">in</span> <span class="n">directives</span><span class="p">:</span>
                    <span class="n">directives</span> <span class="o">=</span> <span class="n">directives</span><span class="p">[</span><span class="n">directiveType</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">directives</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The input directives JSON file is either not a dict or does not contain the directive keyword </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">directiveType</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">. This means that &quot;</span> <span class="o">+</span> <span class="n">directiveType</span> <span class="o">+</span> <span class="s2">&quot; will not be done.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">hasFileExtension</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="ow">or</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">isGoogleSheetsFile</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="n">dataFrameTuple</span> <span class="o">=</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">loadSheet</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">,</span> <span class="n">removeRegex</span><span class="o">=</span><span class="n">removeRegex</span><span class="p">,</span> <span class="n">isDefaultSearch</span><span class="o">=</span><span class="n">isDefaultSearch</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dataFrameTuple</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">directiveType</span> <span class="o">==</span> <span class="s2">&quot;modification&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parseModificationSheet</span><span class="p">(</span><span class="o">*</span><span class="n">dataFrameTuple</span><span class="p">)</span>
                    <span class="n">directives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parseAutomationSheet</span><span class="p">(</span><span class="o">*</span><span class="n">dataFrameTuple</span><span class="p">)</span>
                    <span class="n">directives</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">automationDirectives</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">directives</span></div>

    <span class="k">def</span> <span class="nf">_applyModificationDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">recordPath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">modifications</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply modification directives to the given record.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            record: a record from self.extraction extracted from metadata.</span>
<span class="sd">            recordPath: the path to the record in self.extraction, used for printing warning messages.</span>
<span class="sd">            modifications: the modifications to apply to the record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;assign&quot;</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">newField</span><span class="p">,</span> <span class="n">newValue</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">[</span><span class="s2">&quot;assign&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="n">Evaluator</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">newValue</span><span class="o">.</span><span class="n">hasRequiredFields</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
                        <span class="n">newValueForRecord</span> <span class="o">=</span> <span class="n">newValue</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">newField</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newValueForRecord</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was assigned a non list type value but was originally a list type value.&quot;</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newValueForRecord</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was assigned a list type value but was not originally a list type value.&quot;</span><span class="p">)</span>
                        
                        <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValueForRecord</span>
                        
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Field assignment directive </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> missing required field(s) </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">newValue</span><span class="o">.</span><span class="n">requiredFields</span> <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, or a regular expression matched no fields or more than one.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## If this is not a copy when it is a list it has unexpected results.</span>
                    <span class="n">newValueForRecord</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">newField</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newValueForRecord</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was assigned a non list type value but was originally a list type value.&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newValueForRecord</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was assigned a list type value but was not originally a list type value.&quot;</span><span class="p">)</span>
                    
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValueForRecord</span>
                
                <span class="k">if</span> <span class="n">newField</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                    <span class="n">fieldPath</span> <span class="o">=</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="n">newField</span>
                    <span class="k">if</span> <span class="n">fieldPath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">((</span><span class="s2">&quot;assign&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_value&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])</span> <span class="ow">or</span>\
                           <span class="s2">&quot;append&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">or</span> \
                           <span class="s2">&quot;prepend&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">or</span>\
                           <span class="s2">&quot;regex&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">or</span> \
                           <span class="s2">&quot;delete&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was assigned a new value after previously being modified by a different modification directive.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;assign&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;append&quot;</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">newField</span><span class="p">,</span> <span class="n">newValue</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">[</span><span class="s2">&quot;append&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">newField</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">newField</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">minLen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">newValue</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minLen</span><span class="p">):</span>
                        <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">newValue</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])):</span>
                        <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">newValue</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">+=</span> <span class="n">newValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">+=</span> <span class="n">newValue</span>
                    
                <span class="n">fieldPath</span> <span class="o">=</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="n">newField</span>
                <span class="k">if</span> <span class="n">fieldPath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The field, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was deleted before being appended to by a different modification directive.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;append&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;prepend&quot;</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">newField</span><span class="p">,</span> <span class="n">newValue</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">[</span><span class="s2">&quot;prepend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">newField</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">newField</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">minLen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">newValue</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minLen</span><span class="p">):</span>
                        <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])):</span>
                        <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span> <span class="o">+</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span> <span class="o">+</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span>
                    
                <span class="n">fieldPath</span> <span class="o">=</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="n">newField</span>
                <span class="k">if</span> <span class="n">fieldPath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The field, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was deleted before being prepended to by a different modification directive.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;prepend&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;regex&quot;</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">newField</span><span class="p">,</span> <span class="n">regexPair</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">[</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fieldInRecord</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">newField</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                    <span class="n">fieldInRecord</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: regex substitution (&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regexPair</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;) cannot be applied to record with missing field </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])):</span>
                        <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regexPair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">regexPair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">oldValue</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regexPair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">regexPair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">oldValue</span> <span class="o">==</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: regex substitution (&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regexPair</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;) produces no change in field </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> value </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">oldValue</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                <span class="n">fieldPath</span> <span class="o">=</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="n">newField</span>
                <span class="k">if</span> <span class="n">fieldPath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The field, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was deleted by a modification directive before attempting to be modified by a regex modification directive.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;assign&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The field, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, had a regex substitution applied after previously being assigned a new value by an assignment modification directive.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">fieldInRecord</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="k">if</span> <span class="n">fieldInRecord</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;regex&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">deletedField</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">[</span><span class="s2">&quot;delete&quot;</span><span class="p">]:</span>
                <span class="n">record</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">deletedField</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                
                <span class="n">fieldPath</span> <span class="o">=</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="n">deletedField</span>
                <span class="k">if</span> <span class="n">fieldPath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;assign&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">or</span>\
                       <span class="s2">&quot;append&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">or</span> \
                       <span class="s2">&quot;prepend&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">or</span>\
                       <span class="s2">&quot;regex&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">or</span>\
                       <span class="s2">&quot;rename&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The field, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">deletedField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was deleted after previously being modified by a different modification directive.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;delete&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;rename&quot;</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">oldField</span><span class="p">,</span><span class="n">newField</span> <span class="ow">in</span> <span class="n">modifications</span><span class="p">[</span><span class="s2">&quot;rename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fieldInRecord</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">oldField</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="n">newField</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: A modification directive has renamed the field </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">oldField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> to </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> for record &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, but </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> already existed in the record, so its value was overwritten.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

                    <span class="n">fieldInRecord</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">oldField</span><span class="p">]</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">oldField</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldInRecord</span><span class="p">:</span>
                    <span class="n">fieldPath</span> <span class="o">=</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="n">oldField</span>
                    <span class="k">if</span> <span class="n">fieldPath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The field, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">oldField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was deleted by a modification directive, and then a different modification directive attempted to rename it, but it no longer exists.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fieldPath</span> <span class="o">=</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="n">newField</span>
                    <span class="k">if</span> <span class="n">fieldPath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;delete&quot;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The field, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">newField</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in record, &quot;</span> <span class="o">+</span> <span class="n">recordPath</span> <span class="o">+</span> <span class="s2">&quot;, was deleted by a modification directive, but then a rename directive created it again from a different field.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;rename&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span><span class="p">[</span><span class="n">fieldPath</span><span class="p">][</span><span class="s2">&quot;previous_modification_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">newField</span><span class="p">]</span>
                    
                    <span class="c1">## not sure if the old field that was removed should be added or not.</span>
                    <span class="c1"># if recordPath + oldField not in self.changedRecords:</span>
                    <span class="c1">#     self.changedRecords[recordPath + oldField] = {}</span>
                    
                    <span class="c1"># self.changedRecords[recordPath + oldField][&quot;previous_modification_type&quot;] = &quot;rename&quot;</span>
                    <span class="c1"># self.changedRecords[recordPath + oldField][&quot;previous_modification_value&quot;] = record[newField]</span>


    <span class="k">def</span> <span class="nf">_applyExactModificationDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableKey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests and applies exact modification directives</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            tableKey: table key in modificationDirectives to get to the modification to apply.</span>
<span class="sd">            fieldKey: field key in modificationDirectives to get to the modification to apply.</span>
<span class="sd">            modificationDirectives: contains the modifications to apply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comparisonTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;exact-first&quot;</span><span class="p">,</span> <span class="s2">&quot;exact-first-nowarn&quot;</span><span class="p">,</span> <span class="s2">&quot;exact-unique&quot;</span><span class="p">,</span> <span class="s2">&quot;exact-all&quot;</span><span class="p">]</span>
        <span class="n">firstTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;exact-first&quot;</span><span class="p">,</span> <span class="s2">&quot;exact-first-nowarn&quot;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">comparisonTypes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comparisonType</span> <span class="o">==</span> <span class="s2">&quot;exact-unique&quot;</span><span class="p">:</span>
                <span class="n">isUnique</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isUnique</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">firstTypes</span><span class="p">:</span>
                <span class="n">isFirst</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isFirst</span><span class="o">=</span><span class="kc">False</span>
        
            <span class="n">matchedFieldValues</span> <span class="o">=</span> <span class="p">{}</span>
    
            <span class="k">if</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">]:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">idKey</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">fieldKey</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                        <span class="n">fieldValue</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">fieldKey</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fieldValue</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">specificValue</span> <span class="ow">in</span> <span class="n">fieldValue</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">specificValue</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">isFirst</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">specificValue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matchedFieldValues</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">idKey</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">][</span><span class="n">specificValue</span><span class="p">])</span>
                                            <span class="n">matchedFieldValues</span><span class="p">[</span><span class="n">specificValue</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;idKey&quot;</span><span class="p">:</span><span class="n">idKey</span><span class="p">,</span> <span class="s2">&quot;numberOfMatches&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">specificValue</span><span class="p">))</span>
                                        <span class="k">elif</span> <span class="n">comparisonType</span> <span class="o">==</span> <span class="s2">&quot;exact-first&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: modification directive #&quot;</span> <span class="o">+</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fieldKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">comparisonType</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">specificValue</span> <span class="o">+</span> <span class="s2">&quot; matches more than one record. Only the first record will be changed. Try #match=all if all matching records should be changed, or #match=first-nowarn to silence this message.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                                    
                                    <span class="k">elif</span> <span class="n">isUnique</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">specificValue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matchedFieldValues</span><span class="p">:</span>
                                            <span class="n">matchedFieldValues</span><span class="p">[</span><span class="n">specificValue</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;idKey&quot;</span><span class="p">:</span><span class="n">idKey</span><span class="p">,</span> <span class="s2">&quot;numberOfMatches&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">matchedFieldValues</span><span class="p">[</span><span class="n">specificValue</span><span class="p">][</span><span class="s2">&quot;numberOfMatches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                            
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">idKey</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">][</span><span class="n">specificValue</span><span class="p">])</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">specificValue</span><span class="p">))</span>
                        
                        <span class="k">elif</span> <span class="n">fieldValue</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">isFirst</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">fieldValue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matchedFieldValues</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">idKey</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">])</span>
                                    <span class="n">matchedFieldValues</span><span class="p">[</span><span class="n">fieldValue</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;idKey&quot;</span><span class="p">:</span><span class="n">idKey</span><span class="p">,</span> <span class="s2">&quot;numberOfMatches&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">fieldValue</span><span class="p">))</span>
                                <span class="k">elif</span> <span class="n">comparisonType</span> <span class="o">==</span> <span class="s2">&quot;exact-first&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: modification directive #&quot;</span> <span class="o">+</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fieldKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">comparisonType</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fieldValue</span> <span class="o">+</span> <span class="s2">&quot; matches more than one record. Only the first record will be changed. Try #match=all if all matching records should be changed, or #match=first-nowarn to silence this message.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                            <span class="k">elif</span> <span class="n">isUnique</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">fieldValue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matchedFieldValues</span><span class="p">:</span>
                                    <span class="n">matchedFieldValues</span><span class="p">[</span><span class="n">fieldValue</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;idKey&quot;</span><span class="p">:</span><span class="n">idKey</span><span class="p">,</span> <span class="s2">&quot;numberOfMatches&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">matchedFieldValues</span><span class="p">[</span><span class="n">fieldValue</span><span class="p">][</span><span class="s2">&quot;numberOfMatches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                    
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">idKey</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">fieldValue</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">isUnique</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fieldValue</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">matchedFieldValues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;numberOfMatches&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;idKey&quot;</span><span class="p">]],</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;idKey&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">][</span><span class="n">fieldValue</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">fieldValue</span><span class="p">))</span>




    <span class="k">def</span> <span class="nf">_applyRegexModificationDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableKey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">regexObjects</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests and applies regular expression modification directives.</span>

<span class="sd">        Args:</span>
<span class="sd">            tableKey: table key in modificationDirectives to get to the modification to apply.</span>
<span class="sd">            fieldKey: field key in modificationDirectives to get to the modification to apply.</span>
<span class="sd">            modificationDirectives: contains the modifications to apply.</span>
<span class="sd">            regexObjects: mapping of the regex string in the directives to their compiled objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comparisonTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;regex-first&quot;</span><span class="p">,</span> <span class="s2">&quot;regex-first-nowarn&quot;</span><span class="p">,</span> <span class="s2">&quot;regex-unique&quot;</span><span class="p">,</span> <span class="s2">&quot;regex-all&quot;</span><span class="p">]</span>
        <span class="n">firstTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;regex-first&quot;</span><span class="p">,</span> <span class="s2">&quot;regex-first-nowarn&quot;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">comparisonTypes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comparisonType</span> <span class="o">==</span> <span class="s2">&quot;regex-unique&quot;</span><span class="p">:</span>
                <span class="n">isUnique</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isUnique</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">firstTypes</span><span class="p">:</span>
                <span class="n">isFirst</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isFirst</span><span class="o">=</span><span class="kc">False</span>
        
            <span class="n">matchedRegexIDs</span> <span class="o">=</span> <span class="p">{}</span>
                    
            <span class="k">if</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">]:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">idKey</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">fieldKey</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                        <span class="n">fieldValue</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">fieldKey</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">regexID</span><span class="p">,</span> <span class="n">regexEntry</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fieldValue</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">specificValue</span> <span class="ow">in</span> <span class="n">fieldValue</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regexObjects</span><span class="p">[</span><span class="n">regexID</span><span class="p">],</span> <span class="n">specificValue</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="n">isFirst</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">regexID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matchedRegexIDs</span><span class="p">:</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">idKey</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">regexEntry</span><span class="p">)</span>
                                                <span class="n">matchedRegexIDs</span><span class="p">[</span><span class="n">regexID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;idKey&quot;</span><span class="p">:</span><span class="n">idKey</span><span class="p">,</span> <span class="s2">&quot;numberOfMatches&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">regexID</span><span class="p">))</span>
                                            <span class="k">elif</span> <span class="n">comparisonType</span> <span class="o">==</span> <span class="s2">&quot;regex-first&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: modification directive #&quot;</span> <span class="o">+</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fieldKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">comparisonType</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">regexID</span> <span class="o">+</span> <span class="s2">&quot; matches more than one record. Only the first record will be changed. Try #match=all if all matching records should be changed, or #match=first-nowarn to silence this message.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                                        
                                        <span class="k">elif</span> <span class="n">isUnique</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">regexID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matchedRegexIDs</span><span class="p">:</span>
                                                <span class="n">matchedRegexIDs</span><span class="p">[</span><span class="n">regexID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;idKey&quot;</span><span class="p">:</span><span class="n">idKey</span><span class="p">,</span> <span class="s2">&quot;numberOfMatches&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">matchedRegexIDs</span><span class="p">[</span><span class="n">regexID</span><span class="p">][</span><span class="s2">&quot;numberOfMatches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                                
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">idKey</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">regexEntry</span><span class="p">)</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">regexID</span><span class="p">))</span>
                                                                    
                            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regexObjects</span><span class="p">[</span><span class="n">regexID</span><span class="p">],</span> <span class="n">fieldValue</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">isFirst</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">regexID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matchedRegexIDs</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">idKey</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">regexEntry</span><span class="p">)</span>
                                        <span class="n">matchedRegexIDs</span><span class="p">[</span><span class="n">regexID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;idKey&quot;</span><span class="p">:</span><span class="n">idKey</span><span class="p">,</span> <span class="s2">&quot;numberOfMatches&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">regexID</span><span class="p">))</span>
                                    <span class="k">elif</span> <span class="n">comparisonType</span> <span class="o">==</span> <span class="s2">&quot;regex-first&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: modification directive #&quot;</span> <span class="o">+</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fieldKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">comparisonType</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">regexID</span> <span class="o">+</span> <span class="s2">&quot; matches more than one record. Only the first record will be changed. Try #match=all if all matching records should be changed, or #match=first-nowarn to silence this message.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                                
                                <span class="k">elif</span> <span class="n">isUnique</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">regexID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matchedRegexIDs</span><span class="p">:</span>
                                        <span class="n">matchedRegexIDs</span><span class="p">[</span><span class="n">regexID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;idKey&quot;</span><span class="p">:</span><span class="n">idKey</span><span class="p">,</span> <span class="s2">&quot;numberOfMatches&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">matchedRegexIDs</span><span class="p">[</span><span class="n">regexID</span><span class="p">][</span><span class="s2">&quot;numberOfMatches&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                        
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">idKey</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">regexEntry</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">regexID</span><span class="p">))</span>
                    
                <span class="k">if</span> <span class="n">isUnique</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">regexID</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">matchedRegexIDs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;numberOfMatches&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;idKey&quot;</span><span class="p">]],</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;idKey&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">][</span><span class="n">regexID</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">regexID</span><span class="p">))</span>



    <span class="k">def</span> <span class="nf">_applyLevenshteinModificationDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableKey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests and applies levenshtein modification directives.</span>

<span class="sd">        Args:</span>
<span class="sd">            tableKey: table key in modificationDirectives to get to the modification to apply.</span>
<span class="sd">            fieldKey: field key in modificationDirectives to get to the modification to apply.</span>
<span class="sd">            modificationDirectives: contains the modifications to apply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comparisonTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;levenshtein-first&quot;</span><span class="p">,</span> <span class="s2">&quot;levenshtein-first-nowarn&quot;</span><span class="p">,</span> <span class="s2">&quot;levenshtein-unique&quot;</span><span class="p">,</span> <span class="s2">&quot;levenshtein-all&quot;</span><span class="p">]</span>
        <span class="n">firstTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;levenshtein-first&quot;</span><span class="p">,</span> <span class="s2">&quot;levenshtein-first-nowarn&quot;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">comparisonTypes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comparisonType</span> <span class="o">==</span> <span class="s2">&quot;levenshtein-unique&quot;</span><span class="p">:</span>
                <span class="n">isUnique</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isUnique</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">firstTypes</span><span class="p">:</span>
                <span class="n">isFirst</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isFirst</span><span class="o">=</span><span class="kc">False</span>
        
            <span class="k">if</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">]:</span>
                <span class="n">levenshteinComparisons</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                <span class="n">levenshteinComparisonValues</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">levID</span><span class="p">,</span> <span class="n">levEntry</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">idKey</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">fieldKey</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                            <span class="c1">## If the comparison field is a list field then calculate the distance between all values in the list and use the smallest for comparison.</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">fieldKey</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                                <span class="n">fieldValues</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">fieldKey</span><span class="p">]</span>
                                <span class="n">levenshteinDistances</span> <span class="o">=</span> <span class="p">[</span><span class="n">jellyfish</span><span class="o">.</span><span class="n">levenshtein_distance</span><span class="p">(</span><span class="n">levID</span><span class="p">,</span> <span class="n">specificValue</span><span class="p">)</span> <span class="k">for</span> <span class="n">specificValue</span> <span class="ow">in</span> <span class="n">fieldValues</span><span class="p">]</span>
                                <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">levenshteinDistances</span><span class="p">)</span>
                                <span class="n">levenshteinComparisonValues</span><span class="p">[</span><span class="n">levID</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">fieldValues</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">levenshteinDistances</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">levenshteinDistances</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">jellyfish</span><span class="o">.</span><span class="n">levenshtein_distance</span><span class="p">(</span><span class="n">levID</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="n">fieldKey</span><span class="p">])</span>
                                <span class="n">levenshteinComparisonValues</span><span class="p">[</span><span class="n">levID</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">fieldKey</span><span class="p">]</span>
                
                <span class="n">idKeySet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">levID</span> <span class="ow">in</span> <span class="n">levenshteinComparisons</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">idKeySet</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
                <span class="n">uniqueForIdKey</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idKey</span> <span class="ow">in</span> <span class="n">idKeySet</span><span class="p">:</span>
                    <span class="n">usableLevIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">levID</span> <span class="k">for</span> <span class="n">levID</span> <span class="ow">in</span> <span class="n">levenshteinComparisons</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">idKey</span> <span class="ow">in</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">]]</span>
                    <span class="n">minLevID</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">levenshteinComparisons</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">idKey</span><span class="p">]))</span>
                    <span class="n">minLevValue</span> <span class="o">=</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">minLevID</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span>
                    <span class="c1">## Assign only if there is 1 match to the minimum levenshtein distance.</span>
                    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levKey</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="o">==</span> <span class="n">minLevValue</span> <span class="k">for</span> <span class="n">levKey</span> <span class="ow">in</span> <span class="n">usableLevIDs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">uniqueForIdKey</span><span class="p">[</span><span class="n">idKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">minLevID</span>
                        
                
                <span class="n">uniqueForLevenshteinID</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">levID</span> <span class="ow">in</span> <span class="n">levenshteinComparisons</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">minIDKey</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
                    <span class="n">minIDValue</span> <span class="o">=</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">][</span><span class="n">minIDKey</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">isFirst</span><span class="p">:</span>
                        <span class="n">idKeysThatHaveMinValue</span> <span class="o">=</span> <span class="p">[</span><span class="n">idKey</span> <span class="k">for</span> <span class="n">idKey</span> <span class="ow">in</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">]</span> <span class="k">if</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="o">==</span> <span class="n">minIDValue</span><span class="p">]</span>
                        <span class="n">uniqueForLevenshteinID</span><span class="p">[</span><span class="n">levID</span><span class="p">]</span> <span class="o">=</span> <span class="n">idKeysThatHaveMinValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">comparisonType</span> <span class="o">==</span> <span class="s2">&quot;levenshtein-first&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">idKeysThatHaveMinValue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: modification directive #&quot;</span> <span class="o">+</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fieldKey</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">comparisonType</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">levID</span> <span class="o">+</span> <span class="s2">&quot; matches more than one record. Only the first record will be changed. Try #match=all if all matching records should be changed, or #match=first-nowarn to silence this message.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                    <span class="k">elif</span> <span class="n">isUnique</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="o">==</span> <span class="n">minIDValue</span> <span class="k">for</span> <span class="n">idKey</span> <span class="ow">in</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">uniqueForLevenshteinID</span><span class="p">[</span><span class="n">levID</span><span class="p">]</span> <span class="o">=</span> <span class="n">minIDKey</span>
                            
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">idKeysThatHaveMinValue</span> <span class="o">=</span> <span class="p">[</span><span class="n">idKey</span> <span class="k">for</span> <span class="n">idKey</span> <span class="ow">in</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">]</span> <span class="k">if</span> <span class="n">levenshteinComparisons</span><span class="p">[</span><span class="n">levID</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="o">==</span> <span class="n">minIDValue</span><span class="p">]</span>
                        <span class="n">uniqueForLevenshteinID</span><span class="p">[</span><span class="n">levID</span><span class="p">]</span> <span class="o">=</span> <span class="n">idKeysThatHaveMinValue</span>

                
                <span class="k">if</span> <span class="n">isFirst</span> <span class="ow">or</span> <span class="n">isUnique</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">levID</span><span class="p">,</span> <span class="n">levEntry</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">levID</span> <span class="ow">in</span> <span class="n">uniqueForLevenshteinID</span> <span class="ow">and</span> <span class="n">uniqueForIdKey</span><span class="p">[</span><span class="n">uniqueForLevenshteinID</span><span class="p">[</span><span class="n">levID</span><span class="p">]]</span> <span class="o">==</span> <span class="n">levID</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">uniqueForLevenshteinID</span><span class="p">[</span><span class="n">levID</span><span class="p">]],</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">uniqueForLevenshteinID</span><span class="p">[</span><span class="n">levID</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">levEntry</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">levID</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">levID</span><span class="p">,</span> <span class="n">levEntry</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">levID</span> <span class="ow">in</span> <span class="n">uniqueForLevenshteinID</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">idKey</span> <span class="ow">in</span> <span class="n">uniqueForLevenshteinID</span><span class="p">[</span><span class="n">levID</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_applyModificationDirectives</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">idKey</span><span class="p">],</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">idKey</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">levEntry</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">levID</span><span class="p">))</span>
                
                

<div class="viewcode-block" id="TagParser.modify"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.modify">[docs]</a>    <span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies modificationDirectives to the extracted metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            modificationDirectives: contains the modifications to apply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modificationDirectives</span> <span class="o">=</span> <span class="n">modificationDirectives</span>
        <span class="k">if</span> <span class="n">modificationDirectives</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">modificationDirectives</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">modificationDirectives</span><span class="p">)</span> <span class="c1"># Must make deepcopy since regex objects being embedded.</span>

            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;unusedModifications&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unusedModifications</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;usedModifications&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                
            <span class="c1"># Compile regex objects for comparison.</span>
            <span class="n">regexObjects</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tableDict</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">fieldDict</span> <span class="ow">in</span> <span class="n">tableDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">regex_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;regex-first&quot;</span><span class="p">,</span> <span class="s2">&quot;regex-first-nowarn&quot;</span><span class="p">,</span> <span class="s2">&quot;regex-unique&quot;</span><span class="p">,</span> <span class="s2">&quot;regex-all&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">regex_type</span> <span class="ow">in</span> <span class="n">fieldDict</span><span class="p">:</span>
                            <span class="n">regexObjects</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="n">regexString</span> <span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">regexString</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">regexString</span> <span class="ow">in</span>  <span class="n">fieldDict</span><span class="p">[</span><span class="n">regex_type</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span>
            
            <span class="c1"># Compile regex objects for regex substitution directives.</span>
            <span class="k">for</span> <span class="n">tableDict</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">fieldDict</span> <span class="ow">in</span> <span class="n">tableDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">comparisonTypeDict</span> <span class="ow">in</span> <span class="n">fieldDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">fieldValueDict</span> <span class="ow">in</span> <span class="n">comparisonTypeDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="k">if</span> <span class="s2">&quot;regex&quot;</span> <span class="ow">in</span> <span class="n">fieldValueDict</span><span class="p">:</span>
                                <span class="n">fieldValueDict</span><span class="p">[</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">newField</span> <span class="p">:</span> <span class="p">[</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">regexPair</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">regexPair</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span>
                                                            <span class="k">for</span> <span class="n">newField</span><span class="p">,</span><span class="n">regexPair</span> <span class="ow">in</span> <span class="n">fieldValueDict</span><span class="p">[</span><span class="s2">&quot;regex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>

            <span class="c1"># Create Evaluator objects for assign directives with &quot;eval(...)&quot; values.</span>
            <span class="k">for</span> <span class="n">tableDict</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">fieldDict</span> <span class="ow">in</span> <span class="n">tableDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">comparisonTypeDict</span> <span class="ow">in</span> <span class="n">fieldDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">fieldValueDict</span> <span class="ow">in</span> <span class="n">comparisonTypeDict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="k">if</span> <span class="s2">&quot;assign&quot;</span> <span class="ow">in</span> <span class="n">fieldValueDict</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">newField</span> <span class="ow">in</span> <span class="n">fieldValueDict</span><span class="p">[</span><span class="s2">&quot;assign&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fieldValueDict</span><span class="p">[</span><span class="s2">&quot;assign&quot;</span><span class="p">][</span><span class="n">newField</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">Evaluator</span><span class="o">.</span><span class="n">isEvalString</span><span class="p">(</span><span class="n">fieldValueDict</span><span class="p">[</span><span class="s2">&quot;assign&quot;</span><span class="p">][</span><span class="n">newField</span><span class="p">])):</span>
                                        <span class="n">fieldValueDict</span><span class="p">[</span><span class="s2">&quot;assign&quot;</span><span class="p">][</span><span class="n">newField</span><span class="p">]</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span><span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">changedRecords</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tableKey</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">tableKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fieldKey</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1">## These functions ultimately modify records in self.extraction.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_applyExactModificationDirectives</span><span class="p">(</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_applyRegexModificationDirectives</span><span class="p">(</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">,</span> <span class="n">regexObjects</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_applyLevenshteinModificationDirectives</span><span class="p">(</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">modificationDirectives</span><span class="p">)</span>

            <span class="c1"># Identify changed IDs.</span>
<span class="c1">#            idTranslation = collections.defaultdict(dict)</span>
<span class="c1">#            for tableKey, table in self.extraction.items():</span>
<span class="c1">#                idTranslation[tableKey + &quot;.id&quot;].update({ idKey : record[&quot;id&quot;] for idKey, record in table.items() if idKey != record[&quot;id&quot;] })</span>

            <span class="c1"># Translate changed IDs.</span>
            <span class="n">translated</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tableKey</span><span class="p">,</span><span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
                <span class="n">translated</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">record</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">}</span>
                <span class="c1">## This bit of code appears to be unnecessary and useless. </span>
                <span class="c1">## idTranslation&#39;s keys aren&#39;t fieldkeys so this will never match anything.</span>
<span class="c1">#                for record in table.values():</span>
<span class="c1">#                    for fieldKey, fieldValue in record.items() :</span>
<span class="c1">#                        if fieldKey in idTranslation:</span>
<span class="c1">#                            if type(fieldValue) == list:</span>
<span class="c1">#                                for index in range(len(fieldValue)):</span>
<span class="c1">#                                    if fieldValue[index] in idTranslation[fieldKey]:</span>
<span class="c1">#                                        fieldValue[index] = idTranslation[fieldKey][fieldValue[index]]</span>
<span class="c1">#                            elif fieldValue in idTranslation[fieldKey]:</span>
<span class="c1">#                                record[fieldKey] = idTranslation[fieldKey][fieldValue]</span>

            <span class="k">for</span> <span class="n">tableKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">translated</span><span class="p">[</span><span class="n">tableKey</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: A modification directive has set at least 2 records in the </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">tableKey</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> table to the same id. The output will have less records than expected.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span> <span class="o">=</span> <span class="n">translated</span>

            <span class="c1"># Identify used and unused modification directives.</span>
            <span class="k">for</span> <span class="n">tableKey</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">fieldKey</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">comparisonType</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">modificationID</span> <span class="ow">in</span> <span class="n">modificationDirectives</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">fieldKey</span><span class="p">][</span><span class="n">comparisonType</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">modificationID</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">usedModifications</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">unusedModifications</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">modificationID</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">modificationID</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unusedModifications</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">unusedModifications</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">tableKey</span><span class="p">,</span> <span class="n">fieldKey</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">,</span> <span class="n">modificationID</span><span class="p">))</span></div>

<div class="viewcode-block" id="TagParser.merge"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newMetadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges new metadata with current metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            newMetadata: dict to merge with self.extraction dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tableKey</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">newMetadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tableKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idKey</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">idKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">record</span><span class="p">)</span></div>

<div class="viewcode-block" id="TagParser.isComparable"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.isComparable">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">isComparable</span><span class="p">(</span><span class="n">value1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compares the two values first as strings and then as floats if convertable.</span>

<span class="sd">        Args:</span>
<span class="sd">            value1: first value to compare.</span>
<span class="sd">            value2: second value to compare.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value1</span> <span class="o">==</span> <span class="n">value2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">value1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span>
            <span class="n">value2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">value1</span> <span class="o">==</span> <span class="n">value2</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value1</span> <span class="o">-</span> <span class="n">value2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value1</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">value2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.00000001</span></div>

<div class="viewcode-block" id="TagParser.compare"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otherMetadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">groupSize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">TextIO</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compare current metadata to other metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            otherMetadata: dict to compare with self.extraction.</span>
<span class="sd">            groupSize: number of record ids to print on a single line before printing more on a new line.</span>
<span class="sd">            file: the IO to print messages to, if None then just return True or False instead of printing messages.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if otherMetadata and self.extraction are different, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">different</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">missingTables</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tableKey</span> <span class="k">for</span> <span class="n">tableKey</span> <span class="ow">in</span> <span class="n">otherMetadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">tableKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">missingTables</span><span class="p">:</span>
            <span class="n">different</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing Tables:&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missingTables</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="n">extraTables</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tableKey</span> <span class="k">for</span> <span class="n">tableKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">tableKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">otherMetadata</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">extraTables</span><span class="p">:</span>
            <span class="n">different</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extra Tables:&quot;</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extraTables</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">tableKey</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">otherMetadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tableKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">:</span>
                <span class="n">missingIDs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">idKey</span> <span class="k">for</span> <span class="n">idKey</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">idKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span> <span class="p">]</span>
                <span class="k">if</span> <span class="n">missingIDs</span><span class="p">:</span>
                    <span class="n">different</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Table&quot;</span><span class="p">,</span> <span class="n">tableKey</span><span class="p">,</span> <span class="s2">&quot;with missing records:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                        <span class="k">while</span> <span class="n">missingIDs</span><span class="p">:</span>
                            <span class="n">group</span> <span class="o">=</span> <span class="n">missingIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">groupSize</span><span class="p">]</span>
                            <span class="n">missingIDs</span> <span class="o">=</span> <span class="n">missingIDs</span><span class="p">[</span><span class="n">groupSize</span><span class="p">:]</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="n">extraIDs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">idKey</span> <span class="k">for</span> <span class="n">idKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">idKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">otherMetadata</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span> <span class="p">]</span>
                <span class="k">if</span> <span class="n">extraIDs</span><span class="p">:</span>
                    <span class="n">different</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Table&quot;</span><span class="p">,</span> <span class="n">tableKey</span><span class="p">,</span> <span class="s2">&quot;with extra records:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                        <span class="k">while</span> <span class="n">extraIDs</span><span class="p">:</span>
                            <span class="n">group</span> <span class="o">=</span> <span class="n">extraIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">groupSize</span><span class="p">]</span>
                            <span class="n">extraIDs</span> <span class="o">=</span> <span class="n">extraIDs</span><span class="p">[</span><span class="n">groupSize</span><span class="p">:]</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>

                <span class="k">for</span> <span class="n">idKey</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">idKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]:</span>
                        <span class="n">differentFields</span> <span class="o">=</span> <span class="p">[</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">isComparable</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">idKey</span><span class="p">][</span><span class="n">field</span><span class="p">])</span> <span class="p">]</span>
                        <span class="n">differentFields</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">[</span><span class="n">tableKey</span><span class="p">][</span><span class="n">idKey</span><span class="p">]</span> <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">record</span> <span class="p">])</span>
                        <span class="k">if</span> <span class="n">differentFields</span><span class="p">:</span>
                            <span class="n">different</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Table&quot;</span><span class="p">,</span> <span class="n">tableKey</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">idKey</span><span class="p">,</span> <span class="s2">&quot;with different fields:&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">differentFields</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">different</span></div>

<div class="viewcode-block" id="TagParser.deleteMetadata"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.deleteMetadata">[docs]</a>    <span class="k">def</span> <span class="nf">deleteMetadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete sections of metadata based on given section descriptions.</span>

<span class="sd">        Args:</span>
<span class="sd">            sections: list of sections that are lists of strings. The strings should be regular expressions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compiled_sections</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">keyElement</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">TagParser</span><span class="o">.</span><span class="n">reDetector</span><span class="p">,</span> <span class="n">keyElement</span><span class="p">)</span> <span class="k">else</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">keyElement</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">keyElement</span> <span class="ow">in</span> <span class="n">section</span> <span class="p">]</span> <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span> <span class="p">]</span>

        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">compiled_sections</span><span class="p">:</span>
            <span class="n">matched_key_levels</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">keyDetector</span> <span class="ow">in</span> <span class="n">section</span><span class="p">:</span>
                <span class="n">new_matched_key_levels</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">section_level_tuple</span> <span class="ow">in</span> <span class="n">matched_key_levels</span><span class="p">:</span>
                    <span class="n">new_matched_key_levels</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">keyName</span><span class="p">,</span> <span class="n">section_level_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">section_level_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">keyName</span><span class="p">])</span> <span class="k">for</span> <span class="n">keyName</span> <span class="ow">in</span> <span class="n">section_level_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keyDetector</span><span class="p">,</span><span class="n">keyName</span><span class="p">))</span>
                <span class="n">matched_key_levels</span> <span class="o">=</span> <span class="n">new_matched_key_levels</span>

            <span class="k">for</span> <span class="n">section_level_tuple</span> <span class="ow">in</span> <span class="n">matched_key_levels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">section_level_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">section_level_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">section_level_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></div>

<div class="viewcode-block" id="TagParser.findParent"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.findParent">[docs]</a>    <span class="k">def</span> <span class="nf">findParent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parentID</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">dict</span><span class="p">]</span><span class="o">|</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns parent record for given parentID.</span>

<span class="sd">        Args:</span>
<span class="sd">            parentID: the id to look for in the records of self.extraction.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            None if the parentID was not found, (tableKey,parentRecord) if it was.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tableKey</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">parentID</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">tableKey</span><span class="p">,</span><span class="n">table</span><span class="p">[</span><span class="n">parentID</span><span class="p">])</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generateLineage</span><span class="p">(</span><span class="n">parentID</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parent2children</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates and returns a lineage structure based on the given parentID.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            parentID: key to look for in parent2children.</span>
<span class="sd">            parent2children: dictionary of parentID to list of children.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            None if parentID is not in parent2children, a dictionary of children for the parentID if it is.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parentID</span> <span class="ow">in</span> <span class="n">parent2children</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span> <span class="n">child</span> <span class="p">:</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">_generateLineage</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">parent2children</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">parent2children</span><span class="p">[</span><span class="n">parentID</span><span class="p">]</span> <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="TagParser.generateLineages"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.generateLineages">[docs]</a>    <span class="k">def</span> <span class="nf">generateLineages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates and returns parent-child record lineages.</span>

<span class="sd">        Returns:</span>
<span class="sd">            lineages by tableKey.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entities_with_parentIDs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tableKey</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">entities_with_parentIDs</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">entity</span><span class="p">,</span> <span class="n">tableKey</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">findParent</span><span class="p">(</span><span class="n">entity</span><span class="p">[</span><span class="s2">&quot;parent_id&quot;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;parent_id&quot;</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">)</span>

        <span class="n">parent2children</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">terminalParentsByTable</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entity_tuple</span> <span class="ow">in</span> <span class="n">entities_with_parentIDs</span><span class="p">:</span>
            <span class="n">parent2children</span><span class="p">[</span><span class="n">entity_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;parent_id&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">entity_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">terminalParentsByTable</span><span class="p">[</span><span class="n">entity_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;parent_id&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s2">&quot;parent_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">terminalParentsByTable</span><span class="p">[</span><span class="n">entity_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;parent_id&quot;</span><span class="p">])</span>

        <span class="n">lineages</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tableKey</span> <span class="ow">in</span>  <span class="n">terminalParentsByTable</span><span class="p">:</span>
            <span class="n">lineages</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">parentID</span> <span class="p">:</span> <span class="n">TagParser</span><span class="o">.</span><span class="n">_generateLineage</span><span class="p">(</span><span class="n">parentID</span><span class="p">,</span><span class="n">parent2children</span><span class="p">)</span> <span class="k">for</span> <span class="n">parentID</span> <span class="ow">in</span> <span class="n">terminalParentsByTable</span><span class="p">[</span><span class="n">tableKey</span><span class="p">]</span> <span class="p">}</span>

        <span class="k">return</span> <span class="n">lineages</span></div>

<div class="viewcode-block" id="TagParser.printLineages"><a class="viewcode-back" href="../../../api.html#messes.extract.extract.TagParser.printLineages">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">printLineages</span><span class="p">(</span><span class="n">lineages</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">,</span> <span class="n">indentation</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">groupSize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">file</span> <span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints the given lineages.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            lineages: dictionary where the keys are table names and values are a dictionary of parentID and children.</span>
<span class="sd">            indentation: number of spaces of indentation to print.</span>
<span class="sd">            groupSize: number of childIDs to print per line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lineages</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">lineages</span><span class="p">[</span><span class="nb">id</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="n">indentation</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                <span class="n">terminal_children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">childID</span> <span class="k">for</span> <span class="n">childID</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">lineages</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">children</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">terminal_children</span><span class="p">:</span>
                    <span class="n">children_group</span> <span class="o">=</span> <span class="n">terminal_children</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">groupSize</span><span class="p">]</span>
                    <span class="n">terminal_children</span> <span class="o">=</span> <span class="n">terminal_children</span><span class="p">[</span><span class="n">groupSize</span><span class="p">:]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="p">(</span><span class="n">indentation</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">children_group</span><span class="p">),</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                <span class="n">non_terminal_children</span> <span class="o">=</span> <span class="p">{</span><span class="n">childID</span> <span class="p">:</span> <span class="n">children</span> <span class="k">for</span> <span class="n">childID</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">lineages</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">children</span> <span class="p">}</span>
                <span class="n">TagParser</span><span class="o">.</span><span class="n">printLineages</span><span class="p">(</span><span class="n">non_terminal_children</span><span class="p">,</span><span class="n">indentation</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1">## I don&#39;t think this can be executed from the CLI, I can get it to print if the table in lineages is an empty dict and that&#39;s it.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">*</span><span class="n">indentation</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span></div></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Hunter Moseley, Travis Thompson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>