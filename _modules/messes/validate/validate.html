<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>messes.validate.validate &mdash; MESSES 0.1.dev1+g62b989a documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/custom_css.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js"></script>
        <script src="../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MESSES
          </a>
              <div class="version">
                0.1.dev1+g62b989a
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tagging.html">Tagging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conversion_directives.html">Conversion Directives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiment_description_schema.html">Experiment Description Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../protocol_dependent_schema.html">Protocol-Dependent Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../supported_formats.html">Supported Conversion Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../todo.html">TODO List</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MESSES</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>messes.validate.validate</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for messes.validate.validate</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Validate JSON files.</span>

<span class="sd">Usage:</span>
<span class="sd">    messes validate json &lt;input_JSON&gt; [--pds=&lt;pds&gt; [--csv | --xlsx | --json] | --no_base_schema] </span>
<span class="sd">                                      [--no_extra_checks]</span>
<span class="sd">                                      [--additional=&lt;add_schema&gt;] </span>
<span class="sd">                                      [--format=&lt;format&gt;]</span>
<span class="sd">                                      [--silent=&lt;level&gt;]</span>
<span class="sd">    messes validate save-schema &lt;output_schema&gt; [--input=&lt;input_JSON&gt;] </span>
<span class="sd">                                                [--pds=&lt;pds&gt; [--csv | --xlsx | --json]] </span>
<span class="sd">                                                [--format=&lt;format&gt;]</span>
<span class="sd">                                                [--silent=&lt;level&gt;]</span>
<span class="sd">    messes validate schema &lt;input_schema&gt;</span>
<span class="sd">    messes validate pds &lt;pds&gt; [--csv | --xlsx | --json] [--silent=&lt;level&gt;]</span>
<span class="sd">    messes validate --help</span>
<span class="sd">    </span>
<span class="sd">    &lt;input_JSON&gt; - if &#39;-&#39; read from standard input.</span>
<span class="sd">    &lt;pds&gt; - can be a JSON, csv, or xlsx file. If xlsx the default sheet name to read in is #validate, </span>
<span class="sd">           to specify a different sheet name separate it from the file name with a colon ex: file_name.xlsx:sheet_name.</span>
<span class="sd">           If &#39;-&#39; read from standard input.</span>
<span class="sd">    &lt;input_schema&gt; - must be a valid JSON Schema file. If &#39;-&#39; read from standard input.</span>
<span class="sd">    &lt;output_schema&gt; - if &#39;-&#39; save to standard output.</span>

<span class="sd">Options:</span>
<span class="sd">    -h, --help                           - show this screen.</span>
<span class="sd">    -v, --version                        - show version.</span>
<span class="sd">    --silent &lt;level&gt;                     - if &quot;full&quot; silence all warnings, </span>
<span class="sd">                                           if &quot;nuisance&quot; silence warnings that are more likely to be a nuisance,</span>
<span class="sd">                                           if &quot;none&quot; do not silence warnings [default: none].</span>
<span class="sd">    --pds &lt;pds&gt;                            - a protocol-dependent schema file, can be a JSON, csv, or xlsx file. </span>
<span class="sd">                                           If xlsx the default sheet name to read in is #validate, to specify </span>
<span class="sd">                                           a different sheet name separate it from the file name with a colon </span>
<span class="sd">                                           ex: file_name.xlsx:sheet_name.</span>
<span class="sd">    --csv                                - indicates that the protocol-dependent schema file is a csv (comma delimited) file.</span>
<span class="sd">    --xlsx                               - indicates that the protocol-dependent schema file is an xlsx (Excel) file.</span>
<span class="sd">    --json                               - indicates that the protocol-dependent schema file is a JSON file.</span>
<span class="sd">                                           If a file type is not given then it will be guessed from the file extension.</span>
<span class="sd">    --additional &lt;add_schema&gt;            - an additional JSON Schema file that will be used to validate &lt;input_JSON&gt;.</span>
<span class="sd">    --format &lt;format&gt;                    - additional validation done for the desired supported format. </span>
<span class="sd">                                           Current supported formats: </span>
<span class="sd">                                               mwtab_MS, </span>
<span class="sd">                                               mwtab_NMR, </span>
<span class="sd">                                               mwtab_NMR_bin</span>
<span class="sd">    --no_base_schema                     - don&#39;t validate with the base JSON schema.</span>
<span class="sd">    --no_extra_checks                    - only do JSON Schema validation and nothing else.</span>
<span class="sd">    --input &lt;input_JSON&gt;                 - optionally give an input JSON file to save-schema to reproduce the </span>
<span class="sd">                                           schema used to validate in the json command.</span>
<span class="sd">    </span>

<span class="sd">The &quot;json&quot; command will validate the &lt;input_JSON&gt; against the internal base_schema, and optional schema provided </span>
<span class="sd">by the --pds and --additional options. To validate only against a provided schema, use the --additional and --no_base_schema options.</span>

<span class="sd">The &quot;save-schema&quot; command will save the internal base_schema to the &lt;output_schema&gt; location. If --pds is given </span>
<span class="sd">then it will be parsed and placed into the base_schema. If --input is given the protocols table will be added </span>
<span class="sd">in with the PDS to reproduce what happens in the json command. If --format is used then that format schema is </span>
<span class="sd">saved instead of the base_schema.</span>

<span class="sd">The &quot;schema&quot; command will validate the &lt;input_schema&gt; against the JSON Schema meta schema.</span>

<span class="sd">The &quot;pds&quot; command will validate that the &lt;pds&gt; file is a valid protocol-dependent schema file.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>

<span class="kn">import</span> <span class="nn">docopt</span>
<span class="kn">import</span> <span class="nn">jsonschema</span>

<span class="kn">from</span> <span class="nn">messes</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">messes.extract</span> <span class="kn">import</span> <span class="n">extract</span>
<span class="kn">from</span> <span class="nn">messes.validate.validate_schema</span> <span class="kn">import</span> <span class="n">base_schema</span><span class="p">,</span> <span class="n">PD_schema</span><span class="p">,</span> <span class="n">mwtab_schema_MS</span><span class="p">,</span> <span class="n">mwtab_schema_NMR</span><span class="p">,</span> <span class="n">mwtab_schema_NMR_bin</span>

<span class="n">supported_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mwtab_MS&quot;</span><span class="p">,</span> <span class="s2">&quot;mwtab_NMR&quot;</span><span class="p">,</span> <span class="s2">&quot;mwtab_NMR_bin&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">docopt</span><span class="o">.</span><span class="n">docopt</span><span class="p">(</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">)</span>
    
    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--silent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--silent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--silent&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="s2">&quot;nuisance&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  Unknown silent level, &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--silent&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;. Must be one of </span><span class="se">\&quot;</span><span class="s2">full</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">nuisance</span><span class="se">\&quot;</span><span class="s2">, or </span><span class="se">\&quot;</span><span class="s2">none</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    
    <span class="c1">#######################</span>
    <span class="c1">## Handle json command.</span>
    <span class="c1">#######################</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">]:</span>            
        <span class="n">run_json_command</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;&lt;input_JSON&gt;&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--pds&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--additional&quot;</span><span class="p">],</span> 
                         <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--no_base_schema&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--no_extra_checks&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--csv&quot;</span><span class="p">],</span> 
                         <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--xlsx&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--json&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--silent&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--format&quot;</span><span class="p">])</span>
    
    
    <span class="c1">#############################    </span>
    <span class="c1">## Handle save-schema command</span>
    <span class="c1">#############################</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;save-schema&quot;</span><span class="p">]:</span>
        <span class="n">run_save_schema_command</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;--pds&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;&lt;output_schema&gt;&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--input&quot;</span><span class="p">],</span>
                                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--csv&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--xlsx&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--json&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--silent&quot;</span><span class="p">],</span>
                                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--format&quot;</span><span class="p">])</span>
    
    
    <span class="c1">#########################</span>
    <span class="c1">## Handle schema command.</span>
    <span class="c1">#########################</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]:</span>
        <span class="n">run_schema_command</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;&lt;input_schema&gt;&quot;</span><span class="p">])</span>
        
    
    <span class="c1">#####################</span>
    <span class="c1">## Handle pds command.</span>
    <span class="c1">#####################</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;pds&quot;</span><span class="p">]:</span>
        <span class="n">run_pds_command</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;&lt;pds&gt;&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--csv&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--xlsx&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--json&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--silent&quot;</span><span class="p">])</span>
    
    
    
<span class="c1">## User defined types.</span>
<span class="n">JSON</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span><span class="o">|</span><span class="nb">list</span><span class="o">|</span><span class="nb">str</span><span class="o">|</span><span class="nb">int</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="kc">None</span>
    
<div class="viewcode-block" id="check"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.check">[docs]</a><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check whether the instance conforms to the given format.</span>
<span class="sd">    </span>
<span class="sd">    Modified from jsonschema.FormatChecker.check. Used to raise an error on </span>
<span class="sd">    the custom &quot;integer&quot; and &quot;numeric&quot; formats so their values can be cast </span>
<span class="sd">    to int and float respectively.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance: the instance to check</span>
<span class="sd">        format: the format that instance should conform to</span>

<span class="sd">    Raises:</span>
<span class="sd">        FormatError:</span>
<span class="sd">            if the instance does not conform to ``format``, also raises if it </span>
<span class="sd">            does conform to &quot;integer&quot; or &quot;numeric&quot; formats</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkers</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">func</span><span class="p">,</span> <span class="n">raises</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkers</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">cause</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">raises</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cause</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">FormatError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="si">!r}</span><span class="s2"> is not a </span><span class="si">{</span><span class="nb">format</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="n">cause</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">FormatError</span><span class="p">(</span><span class="s2">&quot;safe to convert to int&quot;</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> 
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;numeric&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">FormatError</span><span class="p">(</span><span class="s2">&quot;safe to convert to float&quot;</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </div>


<div class="viewcode-block" id="convert_formats"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.convert_formats">[docs]</a><span class="k">def</span> <span class="nf">convert_formats</span><span class="p">(</span><span class="n">validator</span><span class="p">:</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">protocols</span><span class="o">.</span><span class="n">Validator</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="nb">str</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="o">|</span><span class="nb">str</span><span class="o">|</span><span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert &quot;integer&quot; and &quot;numeric&quot; formats to int and float.</span>
<span class="sd">    </span>
<span class="sd">    Special function to iterate over JSON schema errors and if the custom &quot;integer&quot; </span>
<span class="sd">    or &quot;numeric&quot; formats are found converts that value in the instance to the </span>
<span class="sd">    appropriate type.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        validator: Validator from the jsonschema library to run iter_errors() on.</span>
<span class="sd">        instance: the instance to have its values converted.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        The modified instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## Get old check to save and restore.</span>
    <span class="n">original_check</span> <span class="o">=</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">FormatChecker</span><span class="o">.</span><span class="n">check</span>
    <span class="c1">## Replace check in FormatChecker.</span>
    <span class="n">jsonschema</span><span class="o">.</span><span class="n">FormatChecker</span><span class="o">.</span><span class="n">check</span> <span class="o">=</span> <span class="n">check</span>
    
    <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">validator</span><span class="o">.</span><span class="n">iter_errors</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;safe to convert to float&quot;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s2">&quot;][&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">relative_path</span><span class="p">)</span>
            <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;instance&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;=float(&quot;</span> <span class="o">+</span> <span class="s2">&quot;instance&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;safe to convert to int&quot;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s2">&quot;][&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">relative_path</span><span class="p">)</span>
            <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;instance&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;=int(float(&quot;</span> <span class="o">+</span> <span class="s2">&quot;instance&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;))&quot;</span><span class="p">)</span>
            
    <span class="n">jsonschema</span><span class="o">.</span><span class="n">FormatChecker</span><span class="o">.</span><span class="n">check</span> <span class="o">=</span> <span class="n">original_check</span>
    
    <span class="k">return</span> <span class="n">instance</span></div>
    
    
<div class="viewcode-block" id="print_better_error_messages"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.print_better_error_messages">[docs]</a><span class="k">def</span> <span class="nf">print_better_error_messages</span><span class="p">(</span><span class="n">errors_generator</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print better error messages for jsonschema validation errors.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        errors_generator: the generator returned from validator.iter_errors().</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        True if there were errors, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors_generator</span><span class="p">:</span>
        <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;minProperties&quot;</span><span class="p">:</span>
            <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; cannot be empty.&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span>
            <span class="n">required_property</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\&#39;.*\&#39;)&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">relative_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;The required property &quot;</span> <span class="o">+</span> <span class="n">required_property</span> <span class="o">+</span> <span class="s2">&quot; is missing.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;The entry &quot;</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s2">&quot;][&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">relative_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; is missing the required property &quot;</span> <span class="o">+</span> <span class="n">required_property</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;The entry &quot;</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s2">&quot;][&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">relative_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; is missing a dependent property.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;dependentRequired&quot;</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;The entry &quot;</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s2">&quot;][&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">relative_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; is missing a dependent property.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;minLength&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">validator_value</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; cannot be an empty string.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; is too short.&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;maxLength&quot;</span><span class="p">:</span>
            <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; is too long.&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;minItems&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">validator_value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; cannot be empty.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; must have at least &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">validator_value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; items.&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">validator_value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; is not any of the allowed types: [&quot;</span>
                <span class="k">for</span> <span class="n">allowed_type</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">validator_value</span><span class="p">:</span>
                    <span class="n">custom_message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\&#39;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">allowed_type</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&#39;</span><span class="s2">, &quot;</span>
                <span class="n">custom_message</span> <span class="o">=</span> <span class="n">custom_message</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">custom_message</span> <span class="o">+=</span> <span class="s2">&quot;].&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; is not of type </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">error</span><span class="o">.</span><span class="n">validator_value</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">.&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span>
            <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; is not one of [&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">validator_value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;].&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span>
            <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; is not a valid &quot;</span> <span class="o">+</span> <span class="n">error</span><span class="o">.</span><span class="n">validator_value</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;pattern&quot;</span><span class="p">:</span>
            <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; does not match the regular expression pattern &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">validator_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;minimum&quot;</span><span class="p">:</span>
            <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; must be greater than or equal to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">validator_value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;maximum&quot;</span><span class="p">:</span>
            <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; must be less than or equal to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">validator_value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">elif</span> <span class="n">error</span><span class="o">.</span><span class="n">validator</span> <span class="o">==</span> <span class="s2">&quot;uniqueItems&quot;</span><span class="p">:</span>
            <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">&quot; has non-unique elements.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        
        <span class="k">if</span> <span class="n">custom_message</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;The value for &quot;</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s2">&quot;][&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">relative_path</span><span class="p">)</span> <span class="o">+</span> <span class="n">custom_message</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">has_errors</span></div>
    
    
<div class="viewcode-block" id="read_and_validate_PDS"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.read_and_validate_PDS">[docs]</a><span class="k">def</span> <span class="nf">read_and_validate_PDS</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_csv</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">is_xlsx</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> 
                                            <span class="n">is_json</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">no_last_message</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSON</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read in the protocol-dependent schema from filepath and validate it.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        filepath: the path to the protocol-dependent schema or &quot;-&quot; meaning to read from stdin.</span>
<span class="sd">        is_csv: whether the protocol-dependent schema is a csv file, used for reading from stdin.</span>
<span class="sd">        is_xlsx: whether the protocol-dependent schema is a xlsx file.</span>
<span class="sd">        is_json: whether the protocol-dependent schema is a json file, used for reading from stdin.</span>
<span class="sd">        no_last_message: if True do not print a message about the protocol-dependent schema being invalid and execution stopping.</span>
<span class="sd">        silent: if &quot;full&quot; do not print any warnings, if &quot;nuisance&quot; do not print nuisance warnings.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        The protocol-dependent schema.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        SystemExit: Will raise errors if filepath does not exist or there is a read in error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">from_stdin</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">filepath</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_csv</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_json</span><span class="p">:</span>
            <span class="c1">## Have to clear the input or the system prints an extra error.</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  When reading the protocol-dependent schema from standard input you must specify that it is &#39;--csv&#39; or &#39;--json&#39;.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
        <span class="n">from_stdin</span> <span class="o">=</span> <span class="kc">True</span>
        
                
    
    <span class="k">if</span> <span class="n">is_csv</span> <span class="ow">or</span> <span class="n">is_xlsx</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">from_stdin</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*(\.xls[xm]?|\.csv)&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)):</span>
        <span class="n">default_sheet_name</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sheet_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_stdin</span> <span class="ow">and</span> <span class="p">(</span><span class="n">reMatch</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.*\.xls[xm]?):(.*)$&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)):</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">reMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># elif not from_stdin and re.search(r&quot;\.xls[xm]?$&quot;, filepath):</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">from_stdin</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.xls[xm]?$&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
            <span class="n">sheet_name</span> <span class="o">=</span> <span class="s2">&quot;#validate&quot;</span>
            <span class="n">default_sheet_name</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tagParser</span> <span class="o">=</span> <span class="n">extract</span><span class="o">.</span><span class="n">TagParser</span><span class="p">()</span>
        <span class="c1">## In order to print error messages correctly we have to know if loadSheet printed a message or not, so temporarily replace stderr.</span>
        <span class="n">old_stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">worksheet_tuple</span> <span class="o">:=</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">loadSheet</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">isDefaultSearch</span><span class="o">=</span><span class="n">default_sheet_name</span><span class="p">):</span>
                <span class="n">tagParser</span><span class="o">.</span><span class="n">parseSheet</span><span class="p">(</span><span class="o">*</span><span class="n">worksheet_tuple</span><span class="p">)</span>
                <span class="n">PDS</span> <span class="o">=</span> <span class="n">tagParser</span><span class="o">.</span><span class="n">extraction</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">old_stderr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">old_stderr</span>
                <span class="k">if</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">():</span>
                    <span class="c1">## Have to trim the extra newline off the end of buffer.</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">default_sheet_name</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  No sheet name was given for the xlsx file, so the default name &quot;</span> <span class="o">+</span>\
                          <span class="s2">&quot;of #validate was used, but it was not found in the file.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">old_stderr</span>
            <span class="k">if</span> <span class="n">from_stdin</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  A problem was encountered when trying to read the protocol-dependent schema from stdin. &quot;</span> <span class="o">+</span>\
                      <span class="s2">&quot;Make sure the indicated file type is correct.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
    
    <span class="k">elif</span> <span class="n">is_json</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">from_stdin</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*\.json$&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">from_stdin</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">PDS</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  A problem was encountered when trying to read the protocol-dependent schema from stdin. &quot;</span> <span class="o">+</span>\
                      <span class="s2">&quot;Make sure the indicated file type is correct.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The value entered for the protocol-dependent schema, &quot;</span> <span class="o">+</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;, is not a valid file path or does not exist.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span><span class="p">:</span>
                <span class="n">PDS</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonFile</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  Unknown file type for the protocol-dependent schema file.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        
    <span class="c1"># if (validate_PDS_parent_protocols(PDS) or validate_with_arbitrary_schema(PDS, PD_schema)) \</span>
    <span class="c1">#    and not no_last_message:</span>
    <span class="n">has_errors</span> <span class="o">=</span> <span class="n">validate_PDS_parent_protocols</span><span class="p">(</span><span class="n">PDS</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>
    <span class="n">has_errors</span> <span class="o">=</span> <span class="n">has_errors</span> <span class="o">|</span> <span class="n">print_better_error_messages</span><span class="p">(</span><span class="n">create_validator</span><span class="p">(</span><span class="n">PD_schema</span><span class="p">)</span><span class="o">.</span><span class="n">iter_errors</span><span class="p">(</span><span class="n">PDS</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">has_errors</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_last_message</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The provided protocol-dependent schema is not valid, so execution stops here.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">PDS</span></div>
            
       
<div class="viewcode-block" id="read_in_JSON_file"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.read_in_JSON_file">[docs]</a><span class="k">def</span> <span class="nf">read_in_JSON_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSON</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read in a JSON file from filepath.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        filepath: the path to the JSON file or &quot;-&quot; meaning to read from stdin.</span>
<span class="sd">        description: a name for the JSON file to print more specific error messages.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        The JSON file.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        SystemExit: Will raise errors if filepath does not exist or there is a read in error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">from_stdin</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">filepath</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
        <span class="n">from_stdin</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The value entered for the &quot;</span> <span class="o">+</span> <span class="n">description</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;, is not a valid file path or does not exist.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">from_stdin</span><span class="p">:</span>
            <span class="n">user_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span><span class="p">:</span>
                <span class="n">user_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonFile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">from_stdin</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  An error was encountered when trying to read in the &quot;</span> <span class="o">+</span> <span class="n">description</span> <span class="o">+</span> <span class="s2">&quot; from standard input.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  An error was encountered when trying to read in the &quot;</span> <span class="o">+</span> <span class="n">description</span> <span class="o">+</span> <span class="s2">&quot;, from the path &quot;</span> <span class="o">+</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">user_json</span>  </div>


<div class="viewcode-block" id="validate_JSON_schema"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.validate_JSON_schema">[docs]</a><span class="k">def</span> <span class="nf">validate_JSON_schema</span><span class="p">(</span><span class="n">user_json_schema</span><span class="p">:</span> <span class="n">JSON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate an arbitrary JSON schema.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        user_json_schema: JSON schema to validate.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        True if there were validation errors, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validator_for_user_schema</span> <span class="o">=</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">validator_for</span><span class="p">(</span><span class="n">user_json_schema</span><span class="p">)</span>
    <span class="n">validator_for_meta_schema</span> <span class="o">=</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">validator_for</span><span class="p">(</span><span class="n">validator_for_user_schema</span><span class="o">.</span><span class="n">META_SCHEMA</span><span class="p">)</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">validator_for_meta_schema</span><span class="p">(</span><span class="n">validator_for_meta_schema</span><span class="o">.</span><span class="n">META_SCHEMA</span><span class="p">)</span>
    <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">validator</span><span class="o">.</span><span class="n">iter_errors</span><span class="p">(</span><span class="n">user_json_schema</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="k">return</span> <span class="n">has_errors</span></div>


<div class="viewcode-block" id="create_validator"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.create_validator">[docs]</a><span class="k">def</span> <span class="nf">create_validator</span><span class="p">(</span><span class="n">schema</span><span class="p">:</span> <span class="n">JSON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">protocols</span><span class="o">.</span><span class="n">Validator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a validator for the given schema.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        schema: the JSON schema to create a validator for.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        A jsonschema.protocols.Validator to validate the schema with an added format checker </span>
<span class="sd">        that is aware of the custom formats &quot;integer&quot; and &quot;numeric&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">validator_for</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
    <span class="n">format_checker</span> <span class="o">=</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">FormatChecker</span><span class="p">()</span>
    <span class="nd">@format_checker</span><span class="o">.</span><span class="n">checks</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">)</span> 
    <span class="k">def</span> <span class="nf">is_integer</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="nd">@format_checker</span><span class="o">.</span><span class="n">checks</span><span class="p">(</span><span class="s1">&#39;numeric&#39;</span><span class="p">)</span> 
    <span class="k">def</span> <span class="nf">is_float</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">validator</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">format_checker</span><span class="o">=</span><span class="n">format_checker</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_PDS_parent_protocols"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.validate_PDS_parent_protocols">[docs]</a><span class="k">def</span> <span class="nf">validate_PDS_parent_protocols</span><span class="p">(</span><span class="n">pds</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate the parent_protocols table of the protocol-dependent schema.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pds: the protocol-dependent schema in JSON form.</span>
<span class="sd">        silent: if &quot;full&quot; do not print any warnings, if &quot;nuisance&quot; do not print nuisance warnings.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        True if there were errors (warnings don&#39;t count), False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;parent_protocol&quot;</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">has_fields</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">pds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">parent_name</span> <span class="o">:=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">):</span>
            <span class="n">ancestors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">parent_attributes</span> <span class="o">=</span> <span class="n">attributes</span>
            <span class="n">has_fields</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">pds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span> <span class="k">else</span> <span class="n">has_fields</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">parent_name</span> <span class="o">:=</span> <span class="n">parent_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">)):</span>
                <span class="n">has_fields</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">pds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span> <span class="k">else</span> <span class="n">has_fields</span>
                <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The protocol, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in the </span><span class="se">\&quot;</span><span class="s2">parent_protocol</span><span class="se">\&quot;</span><span class="s2"> table &quot;</span> <span class="o">+</span> \
                          <span class="s2">&quot;has a circular ancestry, i.e., somewhere in the lineage a protocol has a &quot;</span> <span class="o">+</span>\
                          <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">parent_id</span><span class="se">\&quot;</span><span class="s2"> to a child in the lineage.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="n">parent_attributes</span> <span class="o">=</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">][</span><span class="n">parent_name</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;nuisance&quot;</span> <span class="ow">or</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The protocol, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in the </span><span class="se">\&quot;</span><span class="s2">parent_protocol</span><span class="se">\&quot;</span><span class="s2"> table does not itself have any &quot;</span> <span class="o">+</span>\
                      <span class="s2">&quot;fields to validate, nor do any of its ancestors.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="n">parent_name</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;parent_id&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parent_name</span> <span class="o">==</span> <span class="n">protocol</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The protocol, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in the </span><span class="se">\&quot;</span><span class="s2">parent_protocol</span><span class="se">\&quot;</span><span class="s2"> table &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot;has itself listed for its parent_id. Protocols cannot be their own parents.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The parent protocol, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">parent_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, for the protocol </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> \
                      <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in the </span><span class="se">\&quot;</span><span class="s2">parent_protocol</span><span class="se">\&quot;</span><span class="s2"> table is not itself in the </span><span class="se">\&quot;</span><span class="s2">parent_protocol</span><span class="se">\&quot;</span><span class="s2"> table. &quot;</span> <span class="o">+</span>\
                      <span class="s2">&quot;Parent entities must be in the table as well.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">elif</span> <span class="p">(</span><span class="n">type_to_check</span> <span class="o">:=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">parent_type</span> <span class="o">:=</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">][</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span> <span class="ow">and</span> \
               <span class="n">type_to_check</span> <span class="o">!=</span> <span class="n">parent_type</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The protocol, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, does not have the same type as its parent </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                      <span class="n">parent_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;nuisance&quot;</span> <span class="ow">or</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The parent protocol, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">parent_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, for the protocol </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> \
                      <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in the </span><span class="se">\&quot;</span><span class="s2">parent_protocol</span><span class="se">\&quot;</span><span class="s2"> table is not itself in the protocol-dependent schema. &quot;</span> <span class="o">+</span>\
                      <span class="s2">&quot;Parent entities must be in the protocol-dependent schema as well.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">protocol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;nuisance&quot;</span> <span class="ow">or</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The protocol, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> \
                  <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in the </span><span class="se">\&quot;</span><span class="s2">parent_protocol</span><span class="se">\&quot;</span><span class="s2"> table is not in the protocol-dependent schema.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">has_errors</span></div>



<div class="viewcode-block" id="add_protocols_to_PDS"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.add_protocols_to_PDS">[docs]</a><span class="k">def</span> <span class="nf">add_protocols_to_PDS</span><span class="p">(</span><span class="n">protocol_table</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">pds</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSON</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the protocols from the table to the protocol-dependent schema.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        protocol_table: the protocol table from the input JSON.</span>
<span class="sd">        pds: the protocol-dependent schema in JSON form.</span>
<span class="sd">        silent: if &quot;full&quot; do not print any warnings, if &quot;nuisance&quot; do not print nuisance warnings.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        The updated protocol-dependent schema.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">protocols_to_add</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">protocol_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">:=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">))</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">]:</span>
                    <span class="n">protocols_to_add</span><span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">protocol_type</span> <span class="o">:=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span> <span class="ow">and</span> \
                        <span class="n">protocol_type</span> <span class="o">!=</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">][</span><span class="n">parent</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The protocol from the input JSON, &quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> \
                              <span class="s2">&quot;, does not have the same type as its parent_protocol, &quot;</span> <span class="o">+</span> <span class="n">parent</span> <span class="o">+</span> \
                              <span class="s2">&quot;, in the protocol-dependent schema.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">protocol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The protocol from the input JSON, &quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> \
                          <span class="s2">&quot;, is not in the parent_protocol table of the protocol-dependent schema, &quot;</span> <span class="o">+</span>\
                          <span class="s2">&quot;nor does it have a parent_protocol in the protocol-dependent schema.&quot;</span> <span class="o">+</span>\
                          <span class="s2">&quot; Records with this protocol cannot have thier fields validated.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="c1">## Type is enforced by the base_schema.</span>
            <span class="c1"># elif not silent == &quot;full&quot;:</span>
            <span class="c1">#     print(&quot;Warning:  The parent_protocol field of the protocol, &quot; + protocol + \</span>
            <span class="c1">#           &quot;, from the input JSON is not a string value.&quot; +\</span>
            <span class="c1">#           &quot; Records with this protocol cannot have thier fields validated.&quot;, file=sys.stderr)</span>
        <span class="k">elif</span> <span class="n">protocol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The protocol from the input JSON, &quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="o">+</span> \
                  <span class="s2">&quot;, is not in the parent_protocol table of the protocol-dependent schema, &quot;</span> <span class="o">+</span>\
                  <span class="s2">&quot;nor does it have a parent_protocol field.&quot;</span> <span class="o">+</span>\
                  <span class="s2">&quot; Records with this protocol cannot have thier fields validated.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">protocols_to_add</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pds</span><span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">][</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;parent_id&quot;</span><span class="p">:</span><span class="n">parent</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">pds</span></div>


<div class="viewcode-block" id="build_PD_schema"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.build_PD_schema">[docs]</a><span class="k">def</span> <span class="nf">build_PD_schema</span><span class="p">(</span><span class="n">pds</span><span class="p">:</span> <span class="n">JSON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSON</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a JSON schema from the protocol-dependent schema.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pds: the protocol-dependent schema in JSON form.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        A JSON schema created by combining the base schema and a schema created from the protocol-dependent schema.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">protocol_fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ancestors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">parent_name</span> <span class="o">:=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">parent_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
            <span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">pds</span><span class="p">[</span><span class="s2">&quot;parent_protocol&quot;</span><span class="p">][</span><span class="n">parent_name</span><span class="p">]</span>
        <span class="n">ancestors</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pds</span><span class="p">[</span><span class="n">ancestor</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pds</span><span class="p">[</span><span class="n">protocol</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">protocol_fields</span><span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span>
        
    
    <span class="n">json_schema_numeric_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;multipleOf&quot;</span><span class="p">,</span> <span class="s2">&quot;maximum&quot;</span><span class="p">,</span> <span class="s2">&quot;minimum&quot;</span><span class="p">,</span> 
                                    <span class="s2">&quot;exclusiveMaximum&quot;</span><span class="p">,</span> <span class="s2">&quot;exclusiveMinimum&quot;</span><span class="p">]</span>

    <span class="n">json_schema_integer_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;minLength&quot;</span><span class="p">,</span> <span class="s2">&quot;maxLength&quot;</span><span class="p">,</span> <span class="s2">&quot;minItems&quot;</span><span class="p">,</span> <span class="s2">&quot;maxItems&quot;</span><span class="p">,</span> 
                                    <span class="s2">&quot;maxContains&quot;</span><span class="p">,</span> <span class="s2">&quot;minContains&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;minProperties&quot;</span><span class="p">,</span> <span class="s2">&quot;maxProperties&quot;</span><span class="p">]</span>

    <span class="n">json_schema_complex_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;allOf&quot;</span><span class="p">,</span> <span class="s2">&quot;anyOf&quot;</span><span class="p">,</span> <span class="s2">&quot;oneOf&quot;</span><span class="p">,</span> <span class="s2">&quot;not&quot;</span><span class="p">,</span> <span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="s2">&quot;then&quot;</span><span class="p">,</span> <span class="s2">&quot;else&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="s2">&quot;additionalProperties&quot;</span><span class="p">,</span> <span class="s2">&quot;dependentSchemas&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;unevaluatedProperties&quot;</span><span class="p">,</span> <span class="s2">&quot;unevaluatedItems&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;prefixItems&quot;</span><span class="p">,</span> <span class="s2">&quot;contains&quot;</span><span class="p">,</span> <span class="s2">&quot;patternProperties&quot;</span><span class="p">,</span> <span class="s2">&quot;propertyNames&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;$vocabulary&quot;</span><span class="p">,</span> <span class="s2">&quot;$defs&quot;</span><span class="p">,</span> <span class="s2">&quot;dependentRequired&quot;</span><span class="p">,</span> <span class="s2">&quot;const&quot;</span><span class="p">]</span>

    <span class="n">json_schema_boolean_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;uniqueItems&quot;</span><span class="p">]</span>
    
    <span class="n">allOf</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">protocol_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_attributes</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
                <span class="n">properties</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">properties</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">required</span><span class="p">:</span>
                <span class="n">required</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">schema_keyword</span><span class="p">,</span> <span class="n">keyword_value</span> <span class="ow">in</span> <span class="n">field_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">keyword_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">schema_keyword</span> <span class="o">==</span> <span class="s2">&quot;required&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">keyword_value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">keyword_value</span><span class="p">)</span> <span class="ow">or</span> \
                           <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">keyword_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">keyword_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">):</span>
                               <span class="n">required</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="c1">## String values might need conversion to other things.</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keyword_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">keyword_value</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">schema_keyword</span> <span class="ow">in</span> <span class="n">json_schema_numeric_keywords</span><span class="p">:</span>
                                <span class="n">properties</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]][</span><span class="n">field</span><span class="p">][</span><span class="n">schema_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">keyword_value</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">schema_keyword</span> <span class="ow">in</span> <span class="n">json_schema_integer_keywords</span><span class="p">:</span>
                                <span class="n">properties</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]][</span><span class="n">field</span><span class="p">][</span><span class="n">schema_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">keyword_value</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">schema_keyword</span> <span class="ow">in</span> <span class="n">json_schema_complex_keywords</span><span class="p">:</span>
                                <span class="n">properties</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]][</span><span class="n">field</span><span class="p">][</span><span class="n">schema_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">keyword_value</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">schema_keyword</span> <span class="ow">in</span> <span class="n">json_schema_boolean_keywords</span><span class="p">:</span>
                                <span class="n">properties</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]][</span><span class="n">field</span><span class="p">][</span><span class="n">schema_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">keyword_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="k">else</span> <span class="kc">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">properties</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]][</span><span class="n">field</span><span class="p">][</span><span class="n">schema_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyword_value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">properties</span><span class="p">[</span><span class="n">field_attributes</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]][</span><span class="n">field</span><span class="p">][</span><span class="n">schema_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyword_value</span>
                        
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s2">&quot;protocol&quot;</span><span class="p">:</span>
                <span class="n">if_subschema</span> <span class="o">=</span> <span class="p">{</span>
                                  <span class="s2">&quot;anyOf&quot;</span><span class="p">:[</span>
                                      <span class="p">{</span><span class="s2">&quot;properties&quot;</span><span class="p">:{</span><span class="s2">&quot;id&quot;</span><span class="p">:{</span><span class="s2">&quot;const&quot;</span><span class="p">:</span><span class="n">protocol</span><span class="p">}},</span>
                                      <span class="s2">&quot;required&quot;</span><span class="p">:[</span><span class="s2">&quot;id&quot;</span><span class="p">]},</span>
                                      <span class="p">{</span><span class="s2">&quot;properties&quot;</span><span class="p">:{</span><span class="s2">&quot;parent_id&quot;</span><span class="p">:{</span><span class="s2">&quot;anyOf&quot;</span><span class="p">:[</span>
                                                                  <span class="p">{</span><span class="s2">&quot;const&quot;</span><span class="p">:</span><span class="n">protocol</span><span class="p">},</span> 
                                                                  <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
                                                                   <span class="s2">&quot;contains&quot;</span><span class="p">:{</span><span class="s2">&quot;const&quot;</span><span class="p">:</span><span class="n">protocol</span><span class="p">}}</span>
                                                                  <span class="p">]}},</span>
                                      <span class="s2">&quot;required&quot;</span><span class="p">:[</span><span class="s2">&quot;parent_id&quot;</span><span class="p">]}</span>
                                      <span class="p">]</span>
                                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">if_subschema</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;properties&quot;</span><span class="p">:{</span><span class="s2">&quot;protocol.id&quot;</span><span class="p">:{</span><span class="s2">&quot;anyOf&quot;</span><span class="p">:[</span>
                                                            <span class="p">{</span><span class="s2">&quot;const&quot;</span><span class="p">:</span><span class="n">protocol</span><span class="p">},</span> 
                                                            <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
                                                             <span class="s2">&quot;contains&quot;</span><span class="p">:{</span><span class="s2">&quot;const&quot;</span><span class="p">:</span><span class="n">protocol</span><span class="p">}}</span>
                                                            <span class="p">]}},</span>
                                <span class="s2">&quot;required&quot;</span><span class="p">:[</span><span class="s2">&quot;protocol.id&quot;</span><span class="p">]</span>
                                <span class="p">}</span>
            
            <span class="n">then_subschema</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;properties&quot;</span><span class="p">:</span><span class="n">properties</span><span class="p">[</span><span class="n">table</span><span class="p">]}</span>
            <span class="k">if</span> <span class="n">required</span><span class="p">[</span><span class="n">table</span><span class="p">]:</span>
                <span class="n">then_subschema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">required</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
                
            <span class="n">allof_subschema</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;if&quot;</span><span class="p">:</span><span class="n">if_subschema</span><span class="p">,</span> <span class="s2">&quot;then&quot;</span><span class="p">:</span><span class="n">then_subschema</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">allOf</span><span class="p">:</span>
                <span class="n">allOf</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allof_subschema</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">allOf</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">allof_subschema</span><span class="p">]</span>
                
    <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">allOf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">base_schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">table</span><span class="p">][</span><span class="s2">&quot;additionalProperties&quot;</span><span class="p">][</span><span class="s2">&quot;allOf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span>
        
    <span class="k">return</span> <span class="n">base_schema</span></div>


<div class="viewcode-block" id="id_check"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.id_check">[docs]</a><span class="k">def</span> <span class="nf">id_check</span><span class="p">(</span><span class="n">JSON_file</span><span class="p">:</span> <span class="n">JSON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate id fields for records in JSON_file.</span>
<span class="sd">    </span>
<span class="sd">    Loops over JSON_file and makes sure each field with a period in the name is an id, that each id points to an </span>
<span class="sd">    existing id in another table that exists in JSON_file, that each &quot;parent_id&quot; field points to another record that exists </span>
<span class="sd">    in the same table, and that each &quot;id&quot; field  has a value that is the same as the name of the record.</span>
<span class="sd">    </span>
<span class="sd">    There is a special check for the &quot;entity&quot; table that checks that subject types have a sample type parent. </span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        JSON_file: the JSON to validate ids for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_records</span> <span class="ow">in</span> <span class="n">JSON_file</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">record_name</span><span class="p">,</span> <span class="n">record_fields</span> <span class="ow">in</span> <span class="n">table_records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_value</span> <span class="ow">in</span> <span class="n">record_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            
                <span class="k">if</span> <span class="n">re_match</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;(.*)\.(.*)&quot;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  In the &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; table of the input JSON, the record </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span>\
                                  <span class="n">record_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> has a field, &quot;</span> <span class="o">+</span> <span class="n">field_name</span> <span class="o">+</span> \
                                  <span class="s2">&quot;, with a period in the name, but it is not an id.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                           
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">JSON_file</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  In the &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; table of the input JSON, the record </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                                  <span class="n">record_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> has a field, &quot;</span> <span class="o">+</span> <span class="n">field_name</span> <span class="o">+</span> <span class="s2">&quot;, that is an id to another table, &quot;</span> <span class="o">+</span> \
                                  <span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, but that table is not in the input JSON.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> \
                             <span class="nb">len</span><span class="p">(</span><span class="n">bad_values</span> <span class="o">:=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">field_value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">JSON_file</span><span class="p">[</span><span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  In the &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; table of the input JSON, the record </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                                  <span class="n">record_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> has a field, &quot;</span> <span class="o">+</span> <span class="n">field_name</span> <span class="o">+</span> <span class="s2">&quot;, that has id&#39;s to another table, &quot;</span> <span class="o">+</span> \
                                  <span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, but at least one of the id&#39;s are not in the &quot;</span> <span class="o">+</span> \
                                  <span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; table.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The id&#39;s are: </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bad_values</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                        
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field_value</span> <span class="ow">in</span> <span class="n">JSON_file</span><span class="p">[</span><span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  In the &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; table of the input JSON, the record </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                                  <span class="n">record_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> has a field, &quot;</span> <span class="o">+</span> <span class="n">field_name</span> <span class="o">+</span> <span class="s2">&quot;, that is an id to another table, &quot;</span> <span class="o">+</span> \
                                  <span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, but that id, &quot;</span> <span class="o">+</span> <span class="n">field_value</span> <span class="o">+</span> <span class="s2">&quot;, is not in the &quot;</span> <span class="o">+</span> \
                                  <span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; table.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s2">&quot;parent_id&quot;</span><span class="p">:</span>
                    
                    <span class="c1">## parent_id and lineage of protocols is checked more rigoroursly in another function. Just ignore it here.</span>
                    <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s2">&quot;protocol&quot;</span> <span class="p">:</span>
                        <span class="k">continue</span>
                    
                    <span class="k">if</span> <span class="n">field_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_records</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  In the &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; table of the input JSON, the record </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                              <span class="n">record_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> has a parent_id, &quot;</span> <span class="o">+</span> <span class="n">field_value</span> <span class="o">+</span> <span class="s2">&quot;, but this parent is not in the &quot;</span> <span class="o">+</span> \
                              <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; table.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    
                    <span class="c1">## If a subject has a parent_id it must be a sample.</span>
                    <span class="k">elif</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s2">&quot;entity&quot;</span> <span class="p">:</span>
                                                
                        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">record_fields</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">record_fields</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;subject&quot;</span> <span class="ow">and</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">table_records</span><span class="p">[</span><span class="n">field_value</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">table_records</span><span class="p">[</span><span class="n">field_value</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sample&quot;</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  In the &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; table of the input JSON, the subject type record </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                                      <span class="n">record_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> has a parent_id, &quot;</span> <span class="o">+</span> <span class="n">field_value</span> <span class="o">+</span> \
                                      <span class="s2">&quot;, but this parent is not a sample.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

                <span class="c1">## The logic to let the id field be blank here is because it is checked elsewhere and we don&#39;t want to double print messages.</span>
                <span class="k">elif</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_value</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field_value</span> <span class="o">==</span> <span class="n">record_name</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  In the &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; table of the input JSON, the record </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                          <span class="n">record_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> has an id, &quot;</span> <span class="o">+</span> <span class="n">field_value</span> <span class="o">+</span> \
                          <span class="s2">&quot;, but this is not the same as its own name.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_parent_id"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.validate_parent_id">[docs]</a><span class="k">def</span> <span class="nf">validate_parent_id</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">check_type</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">type_keyword</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>    
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate the &quot;parent_id&quot; fields for the table.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        table: the table to validate {record_name:{attribute1:value1, ...}, ...}.</span>
<span class="sd">        table_name: the name of the table, used for printing better error messages.</span>
<span class="sd">        entity_name: name of the entities of the table, used for printing better error messages.</span>
<span class="sd">        check_type: if True check that the type of the parent is the same as the child.</span>
<span class="sd">        type_keyword: the keyword to use to check the types of the parent and child.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        True if there were errors, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">parent_name</span> <span class="o">:=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">):</span>
            <span class="n">ancestors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">parent_attributes</span> <span class="o">=</span> <span class="n">attributes</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">parent_name</span> <span class="o">:=</span> <span class="n">parent_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">entity</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in the </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                          <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> table has a circular ancestry, i.e., somewhere in the lineage a &quot;</span> <span class="o">+</span> \
                          <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot; has a </span><span class="se">\&quot;</span><span class="s2">parent_id</span><span class="se">\&quot;</span><span class="s2"> to a child in the lineage.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">parent_attributes</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span>
            
            <span class="n">parent_name</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;parent_id&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parent_name</span> <span class="o">==</span> <span class="n">entity</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">entity</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, in the </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                      <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> table has itself listed for its parent_id. &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot;Records cannot be their own parents.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The parent &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">parent_name</span> <span class="o">+</span> \
                      <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, for the &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">entity</span> <span class="o">+</span> \
                      <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> in the </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> table is not itself in the </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                      <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> table. &quot;</span> <span class="o">+</span>\
                      <span class="s2">&quot;Parent entities must be in the table as well.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
                        
            <span class="k">elif</span> <span class="n">check_type</span> <span class="ow">and</span> <span class="p">(</span><span class="n">type_to_check</span> <span class="o">:=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">type_keyword</span><span class="p">))</span> <span class="ow">and</span> \
               <span class="p">(</span><span class="n">parent_type</span> <span class="o">:=</span> <span class="n">table</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">type_keyword</span><span class="p">))</span> <span class="ow">and</span> \
               <span class="n">type_to_check</span> <span class="o">!=</span> <span class="n">parent_type</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot;, </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">entity</span> <span class="o">+</span> \
                      <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">, does not have the same &quot;</span> <span class="o">+</span> <span class="n">type_keyword</span> <span class="o">+</span> <span class="s2">&quot; as its parent </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> \
                      <span class="n">parent_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">has_errors</span> <span class="o">=</span> <span class="kc">True</span>
            
    <span class="k">return</span> <span class="n">has_errors</span></div>


<div class="viewcode-block" id="iterate_string_or_list"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.iterate_string_or_list">[docs]</a><span class="k">def</span> <span class="nf">iterate_string_or_list</span><span class="p">(</span><span class="n">str_or_list</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If str_or_list is a string then make it into a list and return the items for looping.</span>
<span class="sd">    </span>
<span class="sd">    If str_or_list is a list then return it as is.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        str_or_list: a string to return as a list containing that string or a list to return as is.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str_or_list as a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">str_or_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">str_or_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">str_or_list</span><span class="p">]</span></div>
    
    
<div class="viewcode-block" id="SS_protocol_check"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.SS_protocol_check">[docs]</a><span class="k">def</span> <span class="nf">SS_protocol_check</span><span class="p">(</span><span class="n">input_json</span><span class="p">:</span> <span class="n">JSON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates the subjects and samples protocols.</span>
<span class="sd">    </span>
<span class="sd">    Loops over the entity table in input_json and makes sure that each sample/subject </span>
<span class="sd">    has protocols of the correct type depending on its inheritance. </span>
<span class="sd">    Samples that have a sample parent must have a sample_prep type protocol.</span>
<span class="sd">    Samples that have a subject parent must have a collection type protocol.</span>
<span class="sd">    Subjects must have a treatment type protocol.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        input_json: the JSON to validate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="k">if</span> <span class="s2">&quot;protocol&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_json</span> <span class="ow">or</span> <span class="s2">&quot;entity&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="k">for</span> <span class="n">entity_name</span><span class="p">,</span> <span class="n">entity_fields</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">protocol_values</span> <span class="o">:=</span> <span class="n">entity_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol.id&quot;</span><span class="p">))</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">protocol_values</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">protocol_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">has_type_sample_prep</span> <span class="o">=</span> <span class="kc">False</span> 
            <span class="n">has_type_collection</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">has_type_treatment</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">for</span> <span class="n">protocol_name</span> <span class="ow">in</span> <span class="n">iterate_string_or_list</span><span class="p">(</span><span class="n">entity_fields</span><span class="p">[</span><span class="s2">&quot;protocol.id&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">protocol_name</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">protocol_type</span> <span class="o">:=</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">][</span><span class="n">protocol_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">protocol_type</span> <span class="o">==</span> <span class="s2">&quot;sample_prep&quot;</span><span class="p">:</span>
                        <span class="n">has_type_sample_prep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">protocol_type</span> <span class="o">==</span> <span class="s2">&quot;collection&quot;</span><span class="p">:</span>
                        <span class="n">has_type_collection</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">protocol_type</span> <span class="o">==</span> <span class="s2">&quot;treatment&quot;</span><span class="p">:</span>
                        <span class="n">has_type_treatment</span> <span class="o">=</span> <span class="kc">True</span>                                    
                                    
            <span class="k">if</span> <span class="p">(</span><span class="n">entity_type</span> <span class="o">:=</span> <span class="n">entity_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)):</span>
            
                <span class="k">if</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;sample&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">parent</span> <span class="o">:=</span> <span class="n">entity_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_id&quot;</span><span class="p">)):</span>
                    <span class="c1">## If the sample has a parent and it is a sample then it must have a sample_prep type protocol.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">parent_attributes</span> <span class="o">:=</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span> <span class="ow">and</span> \
                       <span class="p">(</span><span class="n">parent_type</span> <span class="o">:=</span> <span class="n">parent_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)):</span>
                        
                        <span class="k">if</span> <span class="n">parent_type</span> <span class="o">==</span> <span class="s2">&quot;sample&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_type_sample_prep</span><span class="p">:</span> 
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  Sample &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> \
                                  <span class="s2">&quot; came from a sample, but does not have a sample_prep protocol.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            
                        <span class="c1">## If the sample has a parent and it is a subject then it must have a collection type protocol.        </span>
                        <span class="k">elif</span> <span class="n">parent_type</span> <span class="o">==</span> <span class="s2">&quot;subject&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_type_collection</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  Sample &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> \
                                  <span class="s2">&quot; came from a subject, but does not have a collection protocol.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>                
                        
                <span class="c1">## Check that each subject has a treatment type protocol.            </span>
                <span class="k">if</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;subject&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_type_treatment</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  Subject &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">&quot; does not have a treatment type protocol.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>


<div class="viewcode-block" id="measurement_protocol_check"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.measurement_protocol_check">[docs]</a><span class="k">def</span> <span class="nf">measurement_protocol_check</span><span class="p">(</span><span class="n">input_json</span><span class="p">:</span> <span class="n">JSON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loops over the measurement table in input_json and makes sure that each measurement </span>
<span class="sd">    has at least one measurement type protocol.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        input_json: the JSON to validate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="k">if</span> <span class="s2">&quot;measurement&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_json</span> <span class="ow">or</span> <span class="s2">&quot;protocol&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">:</span>
        <span class="k">return</span>
            
    <span class="k">for</span> <span class="n">measurement_name</span><span class="p">,</span> <span class="n">measurement_fields</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;measurement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;protocol.id&quot;</span> <span class="ow">in</span> <span class="n">measurement_fields</span><span class="p">:</span>
            <span class="n">has_type_measurement</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">for</span> <span class="n">protocol_name</span> <span class="ow">in</span> <span class="n">iterate_string_or_list</span><span class="p">(</span><span class="n">measurement_fields</span><span class="p">[</span><span class="s2">&quot;protocol.id&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">protocol_name</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                   <span class="p">(</span><span class="n">protocol_type</span> <span class="o">:=</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">][</span><span class="n">protocol_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">protocol_type</span> <span class="o">==</span> <span class="s2">&quot;measurement&quot;</span><span class="p">:</span>
                        <span class="n">has_type_measurement</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_type_measurement</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  Measurement &quot;</span> <span class="o">+</span> <span class="n">measurement_name</span> <span class="o">+</span> \
                      <span class="s2">&quot; does not have a measurement type protocol.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>


<div class="viewcode-block" id="protocol_all_used_check"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.protocol_all_used_check">[docs]</a><span class="k">def</span> <span class="nf">protocol_all_used_check</span><span class="p">(</span><span class="n">input_json</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">tables_with_protocols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates that all protocols in the protocol table are used at least once.</span>
<span class="sd">    </span>
<span class="sd">    Compiles a list of all of the protocols used by the records in tables_with_protocols </span>
<span class="sd">    and checks that every protocol in the protocol table is in that list. For any protocols </span>
<span class="sd">    that appear in the protocol table, but are not used by any records a warning is printed.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        input_json: the JSON to validate.</span>
<span class="sd">        tables_with_protocols: the tables in input_json that have records with &quot;protocol.id&quot; fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;protocol&quot;</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="n">used_protocols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">tables_with_protocols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">protocol_values</span> <span class="o">:=</span> <span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol.id&quot;</span><span class="p">))</span> <span class="ow">and</span> \
                   <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">protocol_values</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">protocol_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">protocol_name</span> <span class="ow">in</span> <span class="n">iterate_string_or_list</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;protocol.id&quot;</span><span class="p">]):</span>
                        <span class="n">used_protocols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">protocol_name</span><span class="p">)</span>                    
    
    <span class="c1">## For every protocol that is in the protocol table but is not used print a warning.          </span>
    <span class="k">for</span> <span class="n">protocol_name</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">used_protocols</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The protocol, &quot;</span> <span class="o">+</span> <span class="n">protocol_name</span> <span class="o">+</span> \
              <span class="s2">&quot;, in the protocol table of the input JSON is not used by any of the entities or measurements.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>


<div class="viewcode-block" id="indexes_of_duplicates_in_list"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.indexes_of_duplicates_in_list">[docs]</a><span class="k">def</span> <span class="nf">indexes_of_duplicates_in_list</span><span class="p">(</span><span class="n">list_of_interest</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">value_to_find</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a list of all of the indexes in list_of_interest where the value equals value_to_find.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        list_of_interest: list to find indexes in.</span>
<span class="sd">        value_to_find: value to look for in list_of_interest and find its index.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        A list of all the indexes where value_to_find is in list_of_interest.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">next_index</span> <span class="o">=</span> <span class="n">list_of_interest</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value_to_find</span><span class="p">,</span> <span class="n">current_index</span><span class="p">)</span>            
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_index</span><span class="p">)</span>
            <span class="n">current_index</span> <span class="o">=</span> <span class="n">next_index</span> <span class="o">+</span> <span class="mi">1</span>
        
    <span class="k">return</span> <span class="n">indexes</span></div>


<div class="viewcode-block" id="protocol_description_check"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.protocol_description_check">[docs]</a><span class="k">def</span> <span class="nf">protocol_description_check</span><span class="p">(</span><span class="n">input_json</span><span class="p">:</span> <span class="n">JSON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks that every description field for the protocols in the protocol table of the metadata are unique.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        input_json: the JSON to validate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;protocol&quot;</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="n">protocols_with_descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="n">protocol_name</span> <span class="k">for</span> <span class="n">protocol_name</span><span class="p">,</span> <span class="n">protocol_fields</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">protocol_fields</span><span class="p">]</span>
    <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="n">protocol_fields</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">protocol_name</span><span class="p">,</span> <span class="n">protocol_fields</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">protocol_fields</span><span class="p">]</span>
    <span class="n">protocols_with_matching_descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="n">indexes_of_duplicates_in_list</span><span class="p">(</span><span class="n">descriptions</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span> <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="p">]</span>
    
    <span class="n">protocols_with_matching_descriptions</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">protocols_with_matching_descriptions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span> <span class="k">for</span> <span class="n">group</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">protocols_with_matching_descriptions</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">protocols_with_matching_descriptions</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">protocols_with_matching_descriptions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">protocols_to_print</span> <span class="o">=</span> <span class="p">[</span><span class="n">protocols_with_descriptions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">protocols_with_matching_descriptions</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The protocols: </span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protocols_to_print</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">have the exact same descriptions.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>
                

<div class="viewcode-block" id="factors_checks"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.factors_checks">[docs]</a><span class="k">def</span> <span class="nf">factors_checks</span><span class="p">(</span><span class="n">input_json</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates some logic about the factors.</span>
<span class="sd">    </span>
<span class="sd">    Checks that every factor in the factor table is used at least once by an entity. </span>
<span class="sd">    Whether or not values in the factor field are allowed values.</span>
<span class="sd">    If there are more than 1 allowed values in the factor field.</span>
<span class="sd">    That factor fields are str or list types.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        input_json: the JSON to validate.</span>
<span class="sd">        silent: if &quot;full&quot; do not print any warnings, if &quot;nuisance&quot; do not print nuisance warnings.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;factor&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_json</span> <span class="ow">or</span> <span class="s2">&quot;entity&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">:</span>
        <span class="k">return</span>
        
    <span class="n">used_factors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">valid_factors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">factor_name</span><span class="p">,</span> <span class="n">factor_fields</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;factor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="o">:=</span> <span class="n">factor_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;field&quot;</span><span class="p">))</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="n">allowed_values</span> <span class="o">:=</span> <span class="n">factor_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_values&quot;</span><span class="p">)):</span>
            <span class="n">used_factors</span><span class="p">[</span><span class="n">factor_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">value</span><span class="p">:</span><span class="kc">False</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">allowed_values</span><span class="p">}</span>
            <span class="n">valid_factors</span><span class="p">[</span><span class="n">factor_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;field&quot;</span><span class="p">:</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;allowed_values&quot;</span><span class="p">:</span><span class="n">allowed_values</span><span class="p">}</span>
    
    <span class="k">for</span> <span class="n">entity_name</span><span class="p">,</span> <span class="n">entity_attributes</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">factor_name</span><span class="p">,</span> <span class="n">factor_fields</span> <span class="ow">in</span> <span class="n">valid_factors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">factor_fields</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span>
            <span class="n">allowed_values</span> <span class="o">=</span> <span class="n">factor_fields</span><span class="p">[</span><span class="s2">&quot;allowed_values&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">entity_factor_value</span> <span class="o">:=</span> <span class="n">entity_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_factor_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">entity_factor_value</span> <span class="ow">in</span> <span class="n">allowed_values</span><span class="p">:</span>
                        <span class="n">used_factors</span><span class="p">[</span><span class="n">factor_name</span><span class="p">][</span><span class="n">entity_factor_value</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span> <span class="ow">or</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;nuisance&quot;</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The entity, &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> \
                              <span class="s2">&quot;, has a value, &quot;</span> <span class="o">+</span> <span class="n">entity_factor_value</span> <span class="o">+</span> <span class="s2">&quot;, in the field, &quot;</span> <span class="o">+</span> \
                              <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;, that is not in the allowed values of the factor, &quot;</span> <span class="o">+</span> \
                              <span class="n">factor_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_factor_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">values_in_allowed_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">entity_factor_value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">allowed_values</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_in_allowed_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">used_factors</span><span class="p">[</span><span class="n">factor_name</span><span class="p">][</span><span class="n">values_in_allowed_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_in_allowed_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The entity, &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> \
                              <span class="s2">&quot;, has more than 1 value in the field, &quot;</span> <span class="o">+</span> \
                              <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;, that is in the allowed values of the factor, &quot;</span> <span class="o">+</span> \
                              <span class="n">factor_name</span> <span class="o">+</span> <span class="s2">&quot;. Entities can only have 1 value from each factor.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;nuisance&quot;</span> <span class="ow">or</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The entity, &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> \
                              <span class="s2">&quot;, has no values in the field, &quot;</span> <span class="o">+</span> \
                              <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;, that are in the allowed values of the factor, &quot;</span> <span class="o">+</span> \
                              <span class="n">factor_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The entity, &quot;</span> <span class="o">+</span> <span class="n">entity_name</span> <span class="o">+</span> \
                          <span class="s2">&quot;, has a field, &quot;</span> <span class="o">+</span> \
                          <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;, that is a field for the factor, &quot;</span> <span class="o">+</span> \
                          <span class="n">factor_name</span> <span class="o">+</span> <span class="s2">&quot;, but it is not a string or list type.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    
    <span class="k">for</span> <span class="n">factor_name</span><span class="p">,</span> <span class="n">allowed_values</span> <span class="ow">in</span> <span class="n">used_factors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">unused_values</span> <span class="o">:=</span> <span class="p">[</span><span class="n">value_name</span> <span class="k">for</span> <span class="n">value_name</span><span class="p">,</span> <span class="n">value_used</span> <span class="ow">in</span> <span class="n">allowed_values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">value_used</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unused_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">allowed_values</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The factor, &quot;</span> <span class="o">+</span> <span class="n">factor_name</span> <span class="o">+</span> <span class="s2">&quot;, was not used by any of the entities.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">unused_value</span> <span class="ow">in</span> <span class="n">unused_values</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The allowed value, &quot;</span> <span class="o">+</span> <span class="n">unused_value</span> <span class="o">+</span> \
                          <span class="s2">&quot;, for the factor, &quot;</span> <span class="o">+</span> <span class="n">factor_name</span> <span class="o">+</span> \
                          <span class="s2">&quot;, in the factor table of the input JSON is not used by any of the entities.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_check_format</span><span class="p">(</span><span class="n">format_check</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check that format_check is a supported format.</span>
<span class="sd">    </span>
<span class="sd">    If format_check is not in supported_formats then print an error and close the program.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        format_check: format to check if it is supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">format_check</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">format_check</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_formats</span><span class="p">:</span>
            <span class="n">extra_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">supported_format</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span> <span class="k">for</span> <span class="n">supported_format</span> <span class="ow">in</span> <span class="n">supported_formats</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  Unknown format, &quot;</span> <span class="o">+</span> <span class="n">format_check</span> <span class="o">+</span> <span class="s2">&quot;. Must be one of:</span><span class="se">\n</span><span class="s2">   &quot;</span> <span class="o">+</span> <span class="n">extra_message</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>


<div class="viewcode-block" id="run_json_command"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.run_json_command">[docs]</a><span class="k">def</span> <span class="nf">run_json_command</span><span class="p">(</span><span class="n">input_json_source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pds_source</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_schema_source</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">,</span> 
                     <span class="n">no_base_schema</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">no_extra_checks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_csv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                     <span class="n">is_xlsx</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">format_check</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the json command.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        input_json_source: either a filepath or &quot;-&quot; to read from stdin.</span>
<span class="sd">        pds_source: either a filepath or &quot;-&quot; to read from stdin, if not None.</span>
<span class="sd">        additional_schema_source: either a filepath or &quot;-&quot; to read from stdin, if not None.</span>
<span class="sd">        no_base_schema: if True do not validate with the base_schema, ignored if pds_source is given.</span>
<span class="sd">        no_extra_checks: if True only do JSON Schema validations.</span>
<span class="sd">        is_csv: if True the pds_source is a csv file.</span>
<span class="sd">        is_xlsx: if True the pds_source is an xlsx file.</span>
<span class="sd">        is_json: if True the pds_source is a JSON file.</span>
<span class="sd">        silent: if &quot;full&quot; do not print any warnings, if &quot;nuisance&quot; do not print nuisance warnings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">_check_format</span><span class="p">(</span><span class="n">format_check</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">pds_source</span><span class="p">:</span>
        <span class="n">PDS</span> <span class="o">=</span> <span class="n">read_and_validate_PDS</span><span class="p">(</span><span class="n">pds_source</span><span class="p">,</span> <span class="n">is_csv</span><span class="p">,</span> <span class="n">is_xlsx</span><span class="p">,</span> <span class="n">is_json</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>
    <span class="c1">## Read in JSON_schema if given.</span>
    <span class="k">if</span> <span class="n">additional_schema_source</span><span class="p">:</span>
        <span class="n">user_json_schema</span> <span class="o">=</span> <span class="n">read_in_JSON_file</span><span class="p">(</span><span class="n">additional_schema_source</span><span class="p">,</span> <span class="s2">&quot;additional schema&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validate_JSON_schema</span><span class="p">(</span><span class="n">user_json_schema</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The provided additional JSON schema is not valid, so execution stops here.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_json_schema</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1">## Read in input_JSON.</span>
    <span class="n">input_json</span> <span class="o">=</span> <span class="n">read_in_JSON_file</span><span class="p">(</span><span class="n">input_json_source</span><span class="p">,</span> <span class="s2">&quot;input JSON&quot;</span><span class="p">)</span>
    
    <span class="c1">## Build PDS and combine with base_schema depending on options and validate.</span>
    <span class="k">if</span> <span class="n">pds_source</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;protocol&quot;</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">:</span>
            <span class="n">add_protocols_to_PDS</span><span class="p">(</span><span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">],</span> <span class="n">PDS</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>
        <span class="n">composite_schema</span> <span class="o">=</span> <span class="n">build_PD_schema</span><span class="p">(</span><span class="n">PDS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validate_JSON_schema</span><span class="p">(</span><span class="n">composite_schema</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error:  The schema created from the protocol-dependent schema is not valid. &quot;</span> <span class="o">+</span>\
                  <span class="s2">&quot;Please look at the errors and fix them to validate the input JSON. &quot;</span> <span class="o">+</span>\
                  <span class="s2">&quot;The save-schema command can be used to save the created schema.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">no_base_schema</span><span class="p">:</span>
        <span class="n">composite_schema</span> <span class="o">=</span> <span class="n">base_schema</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">composite_schema</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1">## Determine the validator for the schema and replace numeric and integer formats by type casting them.</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">create_validator</span><span class="p">(</span><span class="n">composite_schema</span><span class="p">)</span>
    <span class="n">convert_formats</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="n">input_json</span><span class="p">)</span>
    
    <span class="c1"># validate_with_arbitrary_schema(input_json, composite_schema)</span>
    <span class="n">print_better_error_messages</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">iter_errors</span><span class="p">(</span><span class="n">input_json</span><span class="p">))</span>
    
    <span class="c1">## Do additional checks JSON Schema can&#39;t do.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_extra_checks</span><span class="p">:</span>
        <span class="n">check_type_tables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span><span class="s2">&quot;type&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">input_json</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">validate_parent_id</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> 
                              <span class="kc">True</span> <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">check_type_tables</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> 
                              <span class="n">check_type_tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">check_type_tables</span> <span class="k">else</span> <span class="s2">&quot;type&quot;</span><span class="p">)</span>
        <span class="n">id_check</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
        <span class="n">SS_protocol_check</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
        <span class="n">measurement_protocol_check</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
        <span class="n">factors_checks</span><span class="p">(</span><span class="n">input_json</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="n">protocol_all_used_check</span><span class="p">(</span><span class="n">input_json</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="s2">&quot;measurement&quot;</span><span class="p">])</span>
            <span class="n">protocol_description_check</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
    
    <span class="c1">## Do additional schema validation if user provided it.</span>
    <span class="k">if</span> <span class="n">additional_schema_source</span><span class="p">:</span>
        <span class="c1">## Determine the validator for the schema and replace numeric and integer formats by type casting them.</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">create_validator</span><span class="p">(</span><span class="n">user_json_schema</span><span class="p">)</span>
        <span class="n">convert_formats</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="n">input_json</span><span class="p">)</span>
        
        <span class="c1"># validate_with_arbitrary_schema(input_json, user_json_schema)</span>
        <span class="n">print_better_error_messages</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">iter_errors</span><span class="p">(</span><span class="n">input_json</span><span class="p">))</span>
        
    <span class="k">match</span> <span class="n">format_check</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">&quot;mwtab_MS&quot;</span><span class="p">:</span>
            <span class="n">print_better_error_messages</span><span class="p">(</span><span class="n">create_validator</span><span class="p">(</span><span class="n">mwtab_schema_MS</span><span class="p">)</span><span class="o">.</span><span class="n">iter_errors</span><span class="p">(</span><span class="n">input_json</span><span class="p">))</span>
        <span class="k">case</span> <span class="s2">&quot;mwtab_NMR&quot;</span><span class="p">:</span>
            <span class="n">print_better_error_messages</span><span class="p">(</span><span class="n">create_validator</span><span class="p">(</span><span class="n">mwtab_schema_NMR</span><span class="p">)</span><span class="o">.</span><span class="n">iter_errors</span><span class="p">(</span><span class="n">input_json</span><span class="p">))</span>
        <span class="k">case</span> <span class="s2">&quot;mwtab_NMR_bin&quot;</span><span class="p">:</span>
            <span class="n">print_better_error_messages</span><span class="p">(</span><span class="n">create_validator</span><span class="p">(</span><span class="n">mwtab_schema_NMR_bin</span><span class="p">)</span><span class="o">.</span><span class="n">iter_errors</span><span class="p">(</span><span class="n">input_json</span><span class="p">))</span></div>


<div class="viewcode-block" id="run_save_schema_command"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.run_save_schema_command">[docs]</a><span class="k">def</span> <span class="nf">run_save_schema_command</span><span class="p">(</span><span class="n">pds_source</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_schema_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_json_path</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">is_csv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_xlsx</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                            <span class="n">silent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">format_check</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the save-schema command.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pds_source: either a filepath or &quot;-&quot; to read from stdin, if not None.</span>
<span class="sd">        output_schema_path: the path to save the output JSON to.</span>
<span class="sd">        input_json_path: either a filepath or &quot;-&quot; to read from stdin, if not None.</span>
<span class="sd">        is_csv: if True the pds_source is a csv file.</span>
<span class="sd">        is_xlsx: if True the pds_source is an xlsx file.</span>
<span class="sd">        is_json: if True the pds_source is a JSON file.</span>
<span class="sd">        silent: if &quot;full&quot; do not print any warnings, if &quot;nuisance&quot; do not print nuisance warnings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">_check_format</span><span class="p">(</span><span class="n">format_check</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">format_check</span><span class="p">:</span>
        <span class="k">match</span> <span class="n">format_check</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;mwtab_MS&quot;</span><span class="p">:</span>
                <span class="n">composite_schema</span> <span class="o">=</span> <span class="n">mwtab_schema_MS</span>
            <span class="k">case</span> <span class="s2">&quot;mwtab_NMR&quot;</span><span class="p">:</span>
                <span class="n">composite_schema</span> <span class="o">=</span> <span class="n">mwtab_schema_NMR</span>
            <span class="k">case</span> <span class="s2">&quot;mwtab_NMR_bin&quot;</span><span class="p">:</span>
                <span class="n">composite_schema</span> <span class="o">=</span> <span class="n">mwtab_schema_NMR_bin</span>
    
    <span class="k">elif</span> <span class="n">pds_source</span><span class="p">:</span>
        <span class="n">PDS</span> <span class="o">=</span> <span class="n">read_and_validate_PDS</span><span class="p">(</span><span class="n">pds_source</span><span class="p">,</span> <span class="n">is_csv</span><span class="p">,</span> <span class="n">is_xlsx</span><span class="p">,</span> <span class="n">is_json</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_json_path</span><span class="p">:</span>
            <span class="n">input_json</span> <span class="o">=</span> <span class="n">read_in_JSON_file</span><span class="p">(</span><span class="n">input_json_path</span><span class="p">,</span> <span class="s2">&quot;input JSON&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;protocol&quot;</span> <span class="ow">in</span> <span class="n">input_json</span><span class="p">:</span>
                <span class="n">add_protocols_to_PDS</span><span class="p">(</span><span class="n">input_json</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">],</span> <span class="n">PDS</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>
        <span class="n">composite_schema</span> <span class="o">=</span> <span class="n">build_PD_schema</span><span class="p">(</span><span class="n">PDS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validate_JSON_schema</span><span class="p">(</span><span class="n">composite_schema</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The schema created from the protocol-dependent schema is not valid.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">composite_schema</span> <span class="o">=</span> <span class="n">base_schema</span>
    
    <span class="k">if</span> <span class="n">output_schema_path</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">composite_schema</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*\.json$&quot;</span><span class="p">,</span> <span class="n">output_schema_path</span><span class="p">):</span>
            <span class="n">json_save_name</span> <span class="o">=</span> <span class="n">output_schema_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_save_name</span> <span class="o">=</span> <span class="n">output_schema_path</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_save_name</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span><span class="p">:</span>
            <span class="n">jsonFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">composite_schema</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span></div>


<div class="viewcode-block" id="run_schema_command"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.run_schema_command">[docs]</a><span class="k">def</span> <span class="nf">run_schema_command</span><span class="p">(</span><span class="n">input_schema_source</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the schema command.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        input_schema_source: the path to the JSON Schema file to read and validate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_json_schema</span> <span class="o">=</span> <span class="n">read_in_JSON_file</span><span class="p">(</span><span class="n">input_schema_source</span><span class="p">,</span> <span class="s2">&quot;input schema&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_JSON_schema</span><span class="p">(</span><span class="n">user_json_schema</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No errors. This is a valid JSON schema.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_pds_command"><a class="viewcode-back" href="../../../api.html#messes.validate.validate.run_pds_command">[docs]</a><span class="k">def</span> <span class="nf">run_pds_command</span><span class="p">(</span><span class="n">pds_source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_csv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_xlsx</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                   <span class="n">is_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the pds command.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pds_source: either a filepath or &quot;-&quot; to read from stdin.</span>
<span class="sd">        is_csv: if True the pds_source is a csv file.</span>
<span class="sd">        is_xlsx: if True the pds_source is an xlsx file.</span>
<span class="sd">        is_json: if True the pds_source is a JSON file.</span>
<span class="sd">        silent: if &quot;full&quot; do not print any warnings, if &quot;nuisance&quot; do not print nuisance warnings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PDS</span> <span class="o">=</span> <span class="n">read_and_validate_PDS</span><span class="p">(</span><span class="n">pds_source</span><span class="p">,</span> <span class="n">is_csv</span><span class="p">,</span> <span class="n">is_xlsx</span><span class="p">,</span> <span class="n">is_json</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>
    <span class="n">composite_schema</span> <span class="o">=</span> <span class="n">build_PD_schema</span><span class="p">(</span><span class="n">PDS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate_JSON_schema</span><span class="p">(</span><span class="n">composite_schema</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">silent</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning:  The schema created from the protocol-dependent schema is not valid.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Hunter Moseley, Travis Thompson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>